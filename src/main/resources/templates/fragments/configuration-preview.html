<div xmlns:th="http://www.thymeleaf.org" th:fragment="configuration-preview" class="settings-card" id="configuration-preview">
    <h3 th:text="#{visit.sensitivity.preview.title}">Configuration Preview</h3>
    
    <div class="preview-controls">
        <div class="toggle-buttons">
            <button id="current-data-btn" class="btn btn-primary active" onclick="showCurrentData()">
                <span th:text="#{visit.sensitivity.preview.current}">Current Data</span>
            </button>
            <button id="preview-data-btn" class="btn btn-secondary" onclick="showPreviewData()">
                <span th:text="#{visit.sensitivity.preview.new}">Preview Data</span>
                <span id="preview-status" class="status-indicator">
                    <i class="lni lni-spinner-arrow spinning"></i>
                    <span th:text="#{visit.sensitivity.preview.calculating}">Calculating...</span>
                </span>
            </button>
        </div>
        <div class="date-selection">
            <label for="preview-date">Preview Date:</label>
            <input type="date" id="preview-date" th:value="${previewDate}" onchange="onPreviewDateChange()">
        </div>
    </div>
    
    <div class="preview-maps">
        <!-- Current Data Map -->
        <div id="current-map-container" class="map-container active">
            <div id="current-map" class="map" style="height: 400px;"></div>
        </div>
        
        <!-- Preview Data Map -->
        <div id="preview-map-container" class="map-container">
            <div id="preview-map" class="map" style="height: 400px;"></div>
        </div>
    </div>
    
    <div class="preview-info">
        <h4 th:text="#{visit.sensitivity.preview.config.details}">Configuration Details</h4>
        <div class="config-details">
            <div class="detail-group">
                <h4 th:text="#{visit.sensitivity.visit.detection}">Visit Detection</h4>
                <p><strong th:text="#{visit.sensitivity.search.distance}">Search Distance:</strong> 
                   <span th:text="${previewConfig.visitDetection.searchDistanceInMeters}"></span>m</p>
                <p><strong th:text="#{visit.sensitivity.min.points}">Minimum Adjacent Points:</strong> 
                   <span th:text="${previewConfig.visitDetection.minimumAdjacentPoints}"></span></p>
                <p><strong th:text="#{visit.sensitivity.min.stay.time}">Minimum Stay Time:</strong> 
                   <span th:text="${previewConfig.visitDetection.minimumStayTimeInSeconds}"></span>s</p>
            </div>
            <div class="detail-group">
                <h4 th:text="#{visit.sensitivity.visit.merging}">Visit Merging</h4>
                <p><strong th:text="#{visit.sensitivity.search.duration}">Search Duration:</strong> 
                   <span th:text="${previewConfig.visitMerging.searchDurationInHours}"></span>h</p>
                <p><strong th:text="#{visit.sensitivity.max.merge.time}">Max Merge Time:</strong> 
                   <span th:text="${previewConfig.visitMerging.maxMergeTimeBetweenSameVisits}"></span>s</p>
                <p><strong th:text="#{visit.sensitivity.min.distance}">Min Distance:</strong> 
                   <span th:text="${previewConfig.visitMerging.minDistanceBetweenVisits}"></span>m</p>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        (function() {
            const previewId = /*[[${previewId}]]*/ '';
            const userId = /*[[${userId}]]*/ '';
            const previewDate = /*[[${previewDate}]]*/ '';
            let currentMap = null;
            let previewMap = null;
            let currentMapInitialized = false;
            let previewMapInitialized = false;
            let previewReady = false;
            
            window.showCurrentData = function() {
                document.getElementById('current-data-btn').classList.add('active');
                document.getElementById('preview-data-btn').classList.remove('active');
                document.getElementById('current-map-container').classList.add('active');
                document.getElementById('preview-map-container').classList.remove('active');
                
                if (!currentMapInitialized) {
                    initCurrentMap();
                }
            };
            
            window.showPreviewData = function() {
                document.getElementById('current-data-btn').classList.remove('active');
                document.getElementById('preview-data-btn').classList.add('active');
                document.getElementById('current-map-container').classList.remove('active');
                document.getElementById('preview-map-container').classList.add('active');
                
                if (!previewMapInitialized && previewReady) {
                    initPreviewMap();
                }
            };
            
            function initCurrentMap() {
                if (currentMapInitialized) return;
                
                // Initialize Leaflet map for current data
                currentMap = L.map('current-map', {zoomControl: false, attributionControl: false})
                    .setView([window.userSettings?.homeLatitude || 60.1699, window.userSettings?.homeLongitude || 24.9384], 12);
                
                // Add tile layer
                const tilesUrl = window.userSettings?.tiles?.service || 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                const tilesAttribution = window.userSettings?.tiles?.attribution || '© OpenStreetMap contributors';
                
                const tileLayer = window.userSettings?.preferColoredMap ? L.tileLayer : L.tileLayer.grayscale;
                tileLayer(tilesUrl, {
                    maxZoom: 19,
                    attribution: tilesAttribution
                }).addTo(currentMap);
                
                // Load current data for the selected date
                loadCurrentMapData();
                currentMapInitialized = true;
            }
            
            function initPreviewMap() {
                if (previewMapInitialized) return;
                
                // Initialize Leaflet map for preview data
                previewMap = L.map('preview-map', {zoomControl: false, attributionControl: false})
                    .setView([window.userSettings?.homeLatitude || 60.1699, window.userSettings?.homeLongitude || 24.9384], 12);
                
                // Add tile layer
                const tilesUrl = window.userSettings?.tiles?.service || 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                const tilesAttribution = window.userSettings?.tiles?.attribution || '© OpenStreetMap contributors';
                
                const tileLayer = window.userSettings?.preferColoredMap ? L.tileLayer : L.tileLayer.grayscale;
                tileLayer(tilesUrl, {
                    maxZoom: 19,
                    attribution: tilesAttribution
                }).addTo(previewMap);
                
                // Load preview data
                loadPreviewMapData();
                previewMapInitialized = true;
            }
            
            function loadCurrentMapData() {
                if (!currentMap) return;
                
                // Fetch current processed visits/trips for the selected date
                fetch(`/api/timeline/visits?date=${previewDate}&timezone=${getUserTimezone()}`)
                    .then(response => response.json())
                    .then(data => {
                        updateMapWithData(currentMap, data, '#ff6c00');
                    })
                    .catch(error => {
                        console.error('Error loading current map data:', error);
                    });
            }
            
            function loadPreviewMapData() {
                if (!previewMap || !previewReady) return;
                
                // Fetch preview processed visits/trips
                fetch(`/api/preview/${previewId}/visits`)
                    .then(response => response.json())
                    .then(data => {
                        updateMapWithData(previewMap, data, '#4CAF50');
                    })
                    .catch(error => {
                        console.error('Error loading preview map data:', error);
                    });
            }
            
            function updateMapWithData(map, data, color) {
                // Clear existing layers (except tile layer)
                map.eachLayer(layer => {
                    if (!layer._url) {
                        map.removeLayer(layer);
                    }
                });
                
                const bounds = L.latLngBounds();
                let hasValidCoords = false;
                
                // Group places by coordinates to avoid duplicate markers
                const placeGroups = new Map();
                
                if (data.visits) {
                    data.visits.forEach(visit => {
                        const lat = visit.place?.latitudeCentroid;
                        const lng = visit.place?.longitudeCentroid;
                        
                        if (lat && lng) {
                            const coordKey = `${lat.toFixed(6)},${lng.toFixed(6)}`;
                            
                            if (!placeGroups.has(coordKey)) {
                                placeGroups.set(coordKey, {
                                    lat: lat,
                                    lng: lng,
                                    totalDurationMs: 0,
                                    visits: [],
                                    place: visit.place
                                });
                            }
                            
                            const group = placeGroups.get(coordKey);
                            group.totalDurationMs += visit.durationSeconds * 1000;
                            group.visits.push(visit);
                            
                            bounds.extend([lat, lng]);
                            hasValidCoords = true;
                        }
                    });
                }
                
                // Draw markers for grouped places
                placeGroups.forEach((group) => {
                    const { lat, lng, totalDurationMs, visits, place } = group;
                    
                    // Calculate radius using logarithmic scale
                    const durationHours = totalDurationMs / (1000 * 60 * 60);
                    const baseRadius = 15;
                    const maxRadius = 100;
                    const minRadius = 15;
                    
                    const logScale = Math.log(1 + durationHours) / Math.log(1 + 24);
                    const radius = Math.min(maxRadius, Math.max(minRadius, baseRadius + (logScale * (maxRadius - baseRadius))));
                    
                    // Create marker
                    L.circleMarker([lat, lng], {
                        radius: 5,
                        fillColor: color,
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    // Create circle with calculated radius
                    const circle = L.circle([lat, lng], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.1,
                        radius: radius
                    }).addTo(map);
                    
                    const totalDurationText = humanizeDuration(totalDurationMs, {units: ["h", "m"], round: true});
                    const visitCount = visits.length;
                    const visitText = visitCount === 1 ? 'visit' : 'visits';
                    
                    const tooltip = L.tooltip([lat, lng], {
                        content: `<div style="font-size: 1.4rem; color: wheat">${place.name || 'Unknown Place'}</div>
                         <div style="margin-top: 4px; font-weight: bold;">
                             ${visitCount} ${visitText} - Total: ${totalDurationText}
                         </div>`,
                        className: 'visit-popup',
                        permanent: false
                    });
                    
                    circle.bindTooltip(tooltip);
                });
                
                // Fit map to bounds if we have valid coordinates
                if (hasValidCoords && bounds.isValid()) {
                    map.fitBounds(bounds, {
                        paddingTopLeft: [20, 20],
                        paddingBottomRight: [20, 20],
                        maxZoom: 15
                    });
                }
            }
            
            function getUserTimezone() {
                if (window.userSettings?.timezoneOverride) {
                    return window.userSettings.timezoneOverride;
                } else {
                    return Intl.DateTimeFormat().resolvedOptions().timeZone;
                }
            }
            
            function checkPreviewStatus() {
                // TODO: Poll backend to check if preview calculation is complete
                fetch(`/api/preview/${previewId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.ready) {
                            previewReady = true;
                            document.getElementById('preview-status').innerHTML = 
                                '<i class="lni lni-checkmark-circle"></i><span>Ready</span>';
                            document.getElementById('preview-data-btn').disabled = false;
                            
                            // If preview tab is active, initialize the map
                            if (document.getElementById('preview-data-btn').classList.contains('active')) {
                                initPreviewMap();
                            } else if (previewMapInitialized) {
                                // If map is already initialized, just load the data
                                loadPreviewMapData();
                            }
                        } else {
                            // Continue polling
                            setTimeout(checkPreviewStatus, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking preview status:', error);
                        document.getElementById('preview-status').innerHTML = 
                            '<i class="lni lni-warning"></i><span>Error</span>';
                    });
            }
            
            // Initialize current map by default
            initCurrentMap();
            
            window.onPreviewDateChange = function() {
                const selectedDate = document.getElementById('preview-date').value;
                if (selectedDate) {
                    // Get the current configuration form data
                    const form = document.querySelector('form[action*="/preview"]');
                    if (form) {
                        // Add the selected date to the form
                        let dateInput = form.querySelector('input[name="previewDate"]');
                        if (!dateInput) {
                            dateInput = document.createElement('input');
                            dateInput.type = 'hidden';
                            dateInput.name = 'previewDate';
                            form.appendChild(dateInput);
                        }
                        dateInput.value = selectedDate;
                        
                        // Submit the form to get a new preview
                        form.submit();
                    }
                }
            };
            
            // Start polling for preview status
            checkPreviewStatus();
        })();
    </script>
    
    <style>
        .preview-controls {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .date-selection {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .date-selection label {
            font-weight: 500;
            margin: 0;
        }
        
        .date-selection input[type="date"] {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        .status-indicator {
            font-size: 0.9em;
            color: #666;
        }
        
        .spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .map-container {
            display: none;
        }
        
        .map-container.active {
            display: block;
        }
        
        .config-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
        }
        
        .detail-group h5 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .detail-group p {
            margin: 5px 0;
            font-size: 0.9em;
        }
    </style>
</div>
