<div xmlns:th="http://www.thymeleaf.org" th:fragment="configuration-preview" class="settings-card" id="configuration-preview">
    <h3 th:text="#{visit.sensitivity.preview.title}">Configuration Preview</h3>
    
    <div class="preview-controls">
        <div class="toggle-buttons">
            <button id="current-data-btn" class="btn btn-primary active" onclick="showCurrentData()">
                <span th:text="#{visit.sensitivity.preview.current}">Current Data</span>
            </button>
            <button id="preview-data-btn" class="btn btn-secondary" onclick="showPreviewData()">
                <span th:text="#{visit.sensitivity.preview.new}">Preview Data</span>
                <span id="preview-status" class="status-indicator">
                    <i class="lni lni-spinner-arrow spinning"></i>
                    <span th:text="#{visit.sensitivity.preview.calculating}">Calculating...</span>
                </span>
            </button>
        </div>
    </div>
    
    <div class="preview-maps">
        <!-- Current Data Map -->
        <div id="current-map-container" class="map-container active">
            <div id="current-map" class="map" style="height: 400px;"></div>
        </div>
        
        <!-- Preview Data Map -->
        <div id="preview-map-container" class="map-container">
            <div id="preview-map" class="map" style="height: 400px;"></div>
        </div>
    </div>
    
    <div class="preview-info">
        <h4 th:text="#{visit.sensitivity.preview.config.details}">Configuration Details</h4>
        <div class="config-details">
            <div class="detail-group">
                <h4 th:text="#{visit.sensitivity.visit.detection}">Visit Detection</h4>
                <p><strong th:text="#{visit.sensitivity.search.distance}">Search Distance:</strong> 
                   <span th:text="${previewConfig.visitDetection.searchDistanceInMeters}"></span>m</p>
                <p><strong th:text="#{visit.sensitivity.min.points}">Minimum Adjacent Points:</strong> 
                   <span th:text="${previewConfig.visitDetection.minimumAdjacentPoints}"></span></p>
                <p><strong th:text="#{visit.sensitivity.min.stay.time}">Minimum Stay Time:</strong> 
                   <span th:text="${previewConfig.visitDetection.minimumStayTimeInSeconds}"></span>s</p>
            </div>
            <div class="detail-group">
                <h4 th:text="#{visit.sensitivity.visit.merging}">Visit Merging</h4>
                <p><strong th:text="#{visit.sensitivity.search.duration}">Search Duration:</strong> 
                   <span th:text="${previewConfig.visitMerging.searchDurationInHours}"></span>h</p>
                <p><strong th:text="#{visit.sensitivity.max.merge.time}">Max Merge Time:</strong> 
                   <span th:text="${previewConfig.visitMerging.maxMergeTimeBetweenSameVisits}"></span>s</p>
                <p><strong th:text="#{visit.sensitivity.min.distance}">Min Distance:</strong> 
                   <span th:text="${previewConfig.visitMerging.minDistanceBetweenVisits}"></span>m</p>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        (function() {
            const previewId = /*[[${previewId}]]*/ '';
            const userId = /*[[${userId}]]*/ '';
            let currentMapInitialized = false;
            let previewMapInitialized = false;
            let previewReady = false;
            
            window.showCurrentData = function() {
                document.getElementById('current-data-btn').classList.add('active');
                document.getElementById('preview-data-btn').classList.remove('active');
                document.getElementById('current-map-container').classList.add('active');
                document.getElementById('preview-map-container').classList.remove('active');
                
                if (!currentMapInitialized) {
                    initCurrentMap();
                }
            };
            
            window.showPreviewData = function() {
                document.getElementById('current-data-btn').classList.remove('active');
                document.getElementById('preview-data-btn').classList.add('active');
                document.getElementById('current-map-container').classList.remove('active');
                document.getElementById('preview-map-container').classList.add('active');
                
                if (!previewMapInitialized && previewReady) {
                    initPreviewMap();
                }
            };
            
            function initCurrentMap() {
                // TODO: Initialize current data map
                // Load current visit/trip data for the user
                currentMapInitialized = true;
            }
            
            function initPreviewMap() {
                // TODO: Initialize preview data map
                // Load preview visit/trip data using previewId
                previewMapInitialized = true;
            }
            
            function checkPreviewStatus() {
                // TODO: Poll backend to check if preview calculation is complete
                fetch(`/api/preview/${previewId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.ready) {
                            previewReady = true;
                            document.getElementById('preview-status').innerHTML = 
                                '<i class="lni lni-checkmark-circle"></i><span>Ready</span>';
                            document.getElementById('preview-data-btn').disabled = false;
                            
                            // If preview tab is active, initialize the map
                            if (document.getElementById('preview-data-btn').classList.contains('active')) {
                                initPreviewMap();
                            }
                        } else {
                            // Continue polling
                            setTimeout(checkPreviewStatus, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking preview status:', error);
                        document.getElementById('preview-status').innerHTML = 
                            '<i class="lni lni-warning"></i><span>Error</span>';
                    });
            }
            
            // Initialize current map by default
            initCurrentMap();
            
            // Start polling for preview status
            checkPreviewStatus();
        })();
    </script>
    
    <style>
        .preview-controls {
            margin-bottom: 20px;
        }
        
        .toggle-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .toggle-buttons button {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            font-size: 0.9em;
            color: #666;
        }
        
        .spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .map-container {
            display: none;
        }
        
        .map-container.active {
            display: block;
        }
        
        .config-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
        }
        
        .detail-group h5 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .detail-group p {
            margin: 5px 0;
            font-size: 0.9em;
        }
    </style>
</div>
