<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<!-- Users Content Fragment -->
<div th:fragment="users-content">
    <h2 th:text="#{users.title}">User Management</h2>

    <div th:if="${successMessage}" class="alert alert-success" style="display: block;">
        <span th:text="${successMessage}">User created successfully</span>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger" style="display: block;">
        <span th:text="${errorMessage}">Error message</span>
    </div>
    <div th:if="${requireRelogin}" class="alert alert-warning" style="display: block;">
        <span>Your username has changed to <strong th:text="${newUsername}"></strong>. You will need to log out and log in again with your new username.</span>
    </div>

    <div class="settings-card">
        <h3 th:text="#{users.existing}">Existing Users</h3>
        <div th:if="${users.isEmpty()}">
            <p th:text="#{users.no.users}">No users found.</p>
        </div>

        <table th:if="${!users.isEmpty()}">
            <thead>
            <tr>
                <th th:text="#{users.table.username}">Username</th>
                <th th:text="#{users.table.display.name}">Display Name</th>
                <th th:text="#{users.table.actions}">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user : ${users}" th:attr="data-user-id=${user.id}" class="user-row">
                <td th:text="${user.username}" th:attr="data-username=${user.username}"></td>
                <td th:text="${user.displayName}" th:attr="data-display-name=${user.displayName}"></td>
                <td>
                    <span th:if="${user.username == currentUsername}"
                          th:text="#{users.current.user}">(Current User)</span>
                    <button th:if="${user.username != currentUsername}"
                            class="btn btn-danger"
                            th:attr="hx-post=@{/settings/users/{id}/delete(id=${user.id})}, hx-confirm=#{users.delete.confirm}"
                            hx-target="#user-management"
                            hx-swap="innerHTML"
                            th:text="#{form.delete}">Delete
                    </button>
                    <button class="btn"
                            th:attr="hx-get=@{/settings/user-form(userId=${user.id}, username=${user.username}, displayName=${user.displayName})}"
                            hx-target="#user-form-container"
                            th:text="#{form.update}">Edit
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div id="user-form-container" class="settings-card">
        <div hx-get="/settings/user-form" hx-trigger="load" hx-target="#user-form-container"></div>
    </div>
</div>

<!-- User Form Fragment -->
<div th:fragment="user-form">
    <form hx-target="#user-management" hx-swap="innerHTML" class="user-form" autocomplete="off" 
          th:attr="hx-post=${userId != null ? '/settings/users/update' : '/settings/users'}">
        <input type="hidden" name="userId" th:value="${userId}">
        <h3 th:text="${userId != null ? #messages.msg('users.update.title') : #messages.msg('users.add.title')}">Add New User</h3>
        <div class="form-group">
            <label for="username" th:text="#{users.username.label}">Username</label>
            <input type="text" id="username" name="username" required th:placeholder="#{users.username.placeholder}" autocomplete="off" 
                   th:value="${username}">
        </div>
        <div class="form-group">
            <label for="displayName" th:text="#{users.display.name.label}">Display Name</label>
            <input type="text" id="displayName" name="displayName" required th:placeholder="#{users.display.name.placeholder}" autocomplete="off"
                   th:value="${displayName}">
        </div>
        <div class="form-group">
            <label for="password" th:text="#{users.password.label}">Password</label>
            <input type="password" id="password" name="password" th:required="${userId == null}" th:placeholder="#{users.password.placeholder}" autocomplete="new-password">
            <small th:if="${userId != null}" th:text="#{users.password.keep.current}">Leave empty to keep current password</small>
        </div>
        <div class="form-group">
            <label th:text="#{language.title}">Preferred Language</label>
            <div class="language-selection">
                <div class="language-buttons">
                    <label class="btn language-btn">
                        <input type="radio" name="preferred_language" value="en" th:checked="${selectedLanguage == 'en' || selectedLanguage == null}" style="display: none;">
                        <span class="language-flag">ðŸ‡ºðŸ‡¸</span>
                        <span th:text="#{language.english}" class="language-name">English</span>
                    </label>

                    <label class="btn language-btn">
                        <input type="radio" name="preferred_language" value="fi" th:checked="${selectedLanguage == 'fi'}" style="display: none;">
                        <span class="language-flag">ðŸ‡«ðŸ‡®</span>
                        <span th:text="#{language.finnish}" class="language-name">Suomi</span>
                    </label>

                    <label class="btn language-btn">
                        <input type="radio" name="preferred_language" value="de" th:checked="${selectedLanguage == 'de'}" style="display: none;">
                        <span class="language-flag">ðŸ‡©ðŸ‡ª</span>
                        <span th:text="#{language.german}" class="language-name">Deutsch</span>
                    </label>

                    <label class="btn language-btn">
                        <input type="radio" name="preferred_language" value="fr" th:checked="${selectedLanguage == 'fr'}" style="display: none;">
                        <span class="language-flag">ðŸ‡«ðŸ‡·</span>
                        <span th:text="#{language.french}" class="language-name">FranÃ§ais</span>
                    </label>
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 10px;">
            <button type="submit" class="btn" th:text="${userId != null ? #messages.msg('form.update') : #messages.msg('form.create')}">Create User</button>
            <button type="button" class="btn" th:if="${userId != null}" 
                    hx-get="/settings/user-form" hx-target="#user-form-container" th:text="#{form.cancel}">Cancel</button>
        </div>
    </form>
</div>


</body>
</html>
