<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<div class="years-navigation" th:fragment="years-navigation">
    <div class="timeline-entry trip" data-year="overall"
         hx-get="/statistics/overall"
         hx-target="#statistics-panel"
         hx-trigger="click"
         hx-swap="outerHTML">
        <div class="entry-description" th:text="#{statistics.overall}">Overall</div>
    </div>
    <div class="timeline-entry trip" th:each="year : ${years}"
         th:attr="hx-get='/statistics/'+ ${year}"
         hx-target="#statistics-panel"
         hx-trigger="click"
         hx-swap="outerHTML">
        <div class="entry-description" th:text="${year}">2024</div>
    </div>
    <script>
        document.querySelector('.years-navigation').addEventListener('click', function (event) {
            const entry = event.target.closest('.timeline-entry');
            if (!entry) return;
            const isCurrentlyActive = entry.classList.contains('active');
             document.querySelectorAll('.timeline-container .timeline-entry')
                .forEach(e => e.classList.remove('active'));
            if (!isCurrentlyActive) {
                entry.classList.add('active');
            }
        });
    </script>
</div>

<div th:fragment="statistics-content" id="statistics-panel" class="statistics-content">
    <script th:inline="javascript">
        // Configuration object for this fragment
        const statisticsConfig = {
            transportStatsData: /*[[${transportStats}]]*/ [],
            monthlyTransportData: /*[[${monthlyTransportData}]]*/ [],
            transportColors: {
                'DRIVING': '#FF6384',
                'WALKING': '#36A2EB',
                'CYCLING': '#FFCE56',
                'public_transport': '#4BC0C0',
                'unknown': '#FF9F40'
            }
        };
        
        // Initialize place maps for this fragment
        function initializePlaceMaps() {
            const mapContainers = document.querySelectorAll('.place-map:not([data-map-initialized])');
            
            mapContainers.forEach((container, index) => {
                container.setAttribute('data-map-initialized', 'true');
                
                const lat = parseFloat(container.getAttribute('data-lat')) || 53.8;
                const lng = parseFloat(container.getAttribute('data-lng')) || 10.7;
                
                const map = L.map(container, {
                    center: [lat, lng],
                    zoom: 15,
                    zoomControl: false,
                    attributionControl: false,
                    dragging: false,
                    touchZoom: false,
                    doubleClickZoom: false,
                    scrollWheelZoom: false,
                    boxZoom: false,
                    keyboard: false
                });
                
                L.tileLayer.grayscale('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ''
                }).addTo(map);
                
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            });
        }
        
        
        // Execute initialization
        initializePlaceMaps();
    </script>
    <h2 th:text="${title}">Statistics</h2>
    
    <!-- Top Visits Section -->
    <div class="statistics-section">
        <h3 th:text="#{statistics.top.places}">Top Places by Stay Time</h3>
        <div class="places-stats-grid">
            <div class="place-stats-card" th:each="visit, visitStat : ${topVisits}">
                <div class="place-map-container">
                    <div class="place-map" 
                         th:id="'place-map-' + ${visitStat.index}"
                         th:data-lat="${visit.latitude}"
                         th:data-lng="${visit.longitude}"></div>
                </div>
                <div class="place-name" th:text="${visit.placeName}">Home</div>
                <div class="place-stats">
                    <div class="place-stat-item">
                        <span class="place-stat-label" th:text="#{statistics.total.hours}">Total Hours</span>
                        <span class="place-stat-value" th:text="${visit.totalStayTimeHours} + 'h'">2400h</span>
                    </div>
                    <div class="place-stat-item">
                        <span class="place-stat-label" th:text="#{statistics.visits}">Visits</span>
                        <span class="place-stat-value" th:text="${visit.visitCount}">365</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transport Statistics Section -->
    <div class="statistics-section">
        <h3 th:text="#{statistics.transport.distance}">Distance by Transport Mode</h3>
        
        <div th:if="${statisticsType == 'overall'}" class="pie-chart-container">
            <canvas id="transportPieChart_overall"></canvas>
        </div>
        
        <div th:if="${statisticsType == 'year'}" class="transport-charts-container">
            <div class="transport-chart-section">
                <div class="transport-chart-title" th:text="#{statistics.transport.distribution}">Transport Distribution</div>
                <div class="pie-chart-container">
                    <canvas th:id="'transportPieChart_' + ${year}"></canvas>
                </div>
            </div>
            <div class="transport-chart-section">
                <div class="transport-chart-title" th:text="#{statistics.monthly.breakdown}">Monthly Breakdown</div>
                <div class="chart-container">
                    <canvas th:id="'monthlyTransportChart_' + ${year}"></canvas>
                </div>
            </div>
        </div>
        
        <div th:if="${statisticsType == 'month'}" class="transport-charts-container">
            <div class="transport-chart-section">
                <div class="transport-chart-title" th:text="#{statistics.transport.distribution}">Transport Distribution</div>
                <div class="pie-chart-container">
                    <canvas th:id="'transportPieChart_' + ${year} + '_' + ${month}"></canvas>
                </div>
            </div>
            <div class="transport-chart-section">
                <div class="transport-chart-title" th:text="#{statistics.daily.breakdown}">Daily Breakdown</div>
                <div class="chart-container">
                    <canvas th:id="'dailyTransportChart_' + ${year} + '_' + ${month}"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Monthly breakdown for year view -->
    <div th:if="${statisticsType == 'year'}" class="statistics-section">
        <h3 th:text="#{statistics.monthly.breakdown}">Monthly Breakdown</h3>
        <div class="months-grid">
            <div class="month-item" th:each="month : ${months}"
                 th:attr="hx-get='/statistics/' + ${year} + '/' + ${month}, hx-target='#month-details-' + ${month}"
                 hx-trigger="click">
                <span th:text="#{${'month.' + month}}">JANUARY</span>
                <div th:id="'month-details-' + ${month}" class="month-details">
                    <!-- Month details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="month-content" class="month-content">
    <script th:inline="javascript">
        // Configuration object for month content - unique per month
        const monthConfig_/*[[${year}]]*/_/*[[${month}]]*/
            = {
            transportStatsData: /*[[${transportStats}]]*/ [],
            dailyTransportData: /*[[${dailyTransportData}]]*/ [],
            year: /*[[${year}]]*/ null,
            month: /*[[${month}]]*/ null,
            transportColors: {
                'DRIVING': '#FF6384',
                'WALKING': '#36A2EB',
                'CYCLING': '#FFCE56',
                'public_transport': '#4BC0C0',
                'unknown': '#FF9F40'
            }
        };
        
        // Initialize place maps for month content
        function initializeMonthPlaceMaps() {
            const mapContainers = document.querySelectorAll('.place-map:not([data-map-initialized])');
            
            mapContainers.forEach((container, index) => {
                container.setAttribute('data-map-initialized', 'true');
                
                const lat = parseFloat(container.getAttribute('data-lat')) || 53.8;
                const lng = parseFloat(container.getAttribute('data-lng')) || 10.7;
                
                const map = L.map(container, {
                    center: [lat, lng],
                    zoom: 15,
                    zoomControl: false,
                    attributionControl: false,
                    dragging: false,
                    touchZoom: false,
                    doubleClickZoom: false,
                    scrollWheelZoom: false,
                    boxZoom: false,
                    keyboard: false
                });
                
                L.tileLayer.grayscale('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ''
                }).addTo(map);
                
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
            });
        }
        
        
        // Execute initialization
        setTimeout(() => {
            initializeMonthPlaceMaps();
        }, 100);
    </script>
    <h4 th:text="${title}">Statistics for January 2024</h4>
    
    <!-- Top Visits Section for Month -->
    <div class="statistics-section">
        <h5 th:text="#{statistics.top.places}">Top Places by Stay Time</h5>
        <div class="places-stats-grid">
            <div class="place-stats-card" th:each="visit, visitStat : ${topVisits}">
                <div class="place-map-container">
                    <div class="place-map" 
                         th:id="'month-place-map-' + ${visitStat.index}"
                         th:data-lat="${visit.latitude}"
                         th:data-lng="${visit.longitude}"></div>
                </div>
                <div class="place-name" th:text="${visit.placeName}">Home</div>
                <div class="place-stats">
                    <div class="place-stat-item">
                        <span class="place-stat-label" th:text="#{statistics.total.hours}">Total Hours</span>
                        <span class="place-stat-value" th:text="${visit.totalStayTimeHours} + 'h'">200h</span>
                    </div>
                    <div class="place-stat-item">
                        <span class="place-stat-label" th:text="#{statistics.visits}">Visits</span>
                        <span class="place-stat-value" th:text="${visit.visitCount}">30</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transport Statistics Section for Month -->
    <div class="statistics-section">
        <h5 th:text="#{statistics.transport.distance}">Distance by Transport Mode</h5>
        
        <div class="transport-charts-container">
            <div class="transport-chart-section">
                <div class="transport-chart-title" th:text="#{statistics.transport.distribution}">Transport Distribution</div>
                <div class="pie-chart-container">
                    <canvas th:id="'monthTransportPieChart_' + ${year} + '_' + ${month}"></canvas>
                </div>
            </div>
            <div class="transport-chart-section">
                <div class="transport-chart-title" th:text="#{statistics.daily.breakdown}">Daily Breakdown</div>
                <div class="chart-container">
                    <canvas th:id="'monthDailyTransportChart_' + ${year} + '_' + ${month}"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
