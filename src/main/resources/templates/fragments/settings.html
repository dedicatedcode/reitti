<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<!-- API Tokens Content Fragment -->
<div th:fragment="api-tokens-content">
    <h2>API Tokens</h2>

    <div th:if="${successMessage}" class="alert alert-success" style="display: block;">
        <span th:text="${successMessage}">Token created successfully</span>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger" style="display: block;">
        <span th:text="${errorMessage}">Error message</span>
    </div>

    <form hx-post="/settings/tokens" hx-target="#api-tokens" hx-swap="innerHTML" class="token-form" style="margin-bottom: 20px;">
        <div class="form-group">
            <label for="tokenName">Token Name</label>
            <input type="text" id="tokenName" name="name" required placeholder="Enter a name for this token">
        </div>
        <button type="submit" class="btn">Create New Token</button>
    </form>

    <div th:if="${tokens.isEmpty()}">
        <p>No API tokens found. Create one to get started.</p>
    </div>
    
    <table th:if="${!tokens.isEmpty()}">
        <thead>
            <tr>
                <th>Name</th>
                <th>Token</th>
                <th>Created</th>
                <th>Last Used</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="token : ${tokens}">
                <td th:text="${token.name}"></td>
                <td th:text="${token.token}"></td>
                <td th:text="${#temporals.format(token.createdAt, 'yyyy-MM-dd HH:mm')}"></td>
                <td th:text="${token.lastUsedAt != null ? #temporals.format(token.lastUsedAt, 'yyyy-MM-dd HH:mm') : 'Never'}"></td>
                <td>
                    <button class="btn btn-danger" 
                            th:attr="hx-post=@{/settings/tokens/{id}/delete(id=${token.id})}"
                            hx-confirm="Are you sure you want to delete this token?"
                            hx-target="#api-tokens"
                            hx-swap="innerHTML">Delete</button>
                </td>
            </tr>
        </tbody>
    </table>
    
    <!-- No script needed here anymore as the form will directly update the content -->
</div>

<!-- Users Content Fragment -->
<div th:fragment="users-content">
    <h2>User Management</h2>

    <div th:if="${successMessage}" class="alert alert-success" style="display: block;">
        <span th:text="${successMessage}">User created successfully</span>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger" style="display: block;">
        <span th:text="${errorMessage}">Error message</span>
    </div>

    <h3>Existing Users</h3>
    <div th:if="${users.isEmpty()}">
        <p>No users found.</p>
    </div>
    
    <table th:if="${!users.isEmpty()}">
        <thead>
            <tr>
                <th>Username</th>
                <th>Display Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="user : ${users}" th:attr="data-user-id=${user.id}" class="user-row">
                <td th:text="${user.username}" th:attr="data-username=${user.username}"></td>
                <td th:text="${user.displayName}" th:attr="data-display-name=${user.displayName}"></td>
                <td>
                    <span th:if="${user.username == currentUsername}">(Current User)</span>
                    <button th:if="${user.username != currentUsername}" 
                            class="btn btn-danger"
                            th:attr="hx-post=@{/settings/users/{id}/delete(id=${user.id})}"
                            hx-confirm="Are you sure you want to delete this user? This will delete all their data."
                            hx-target="#user-management"
                            hx-swap="innerHTML">Delete</button>
                    <button th:if="${user.username != currentUsername}"
                            class="btn"
                            onclick="selectUserForEdit(this.parentElement.parentElement); return false;">Edit</button>
                </td>
            </tr>
        </tbody>
    </table>

    <form id="user-form" hx-target="#user-management" hx-swap="innerHTML" class="user-form" autocomplete="off" style="margin-top: 30px;">
        <input type="hidden" id="userId" name="userId" value="">
        <h3 id="form-title">Add New User</h3>
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" name="username" required placeholder="Enter username" autocomplete="off">
        </div>
        <div class="form-group">
            <label for="displayName">Display Name</label>
            <input type="text" id="displayName" name="displayName" required placeholder="Enter display name" autocomplete="off">
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" required placeholder="Enter password" autocomplete="new-password">
            <small id="password-help" style="display: none;">Leave empty to keep current password</small>
        </div>
        <div style="display: flex; gap: 10px;">
            <button type="submit" id="submit-btn" class="btn">Create User</button>
            <button type="button" id="clear-btn" class="btn" style="display: none;" onclick="clearUserForm()">Cancel</button>
        </div>
    </form>
    
    <script>
        function selectUserForEdit(row) {
            const userId = row.getAttribute('data-user-id');
            const username = row.querySelector('[data-username]').getAttribute('data-username');
            const displayName = row.querySelector('[data-display-name]').getAttribute('data-display-name');
            
            // Update form fields
            document.getElementById('userId').value = userId;
            document.getElementById('username').value = username;
            document.getElementById('displayName').value = displayName;
            
            // Update form appearance
            document.getElementById('form-title').textContent = 'Update User';
            document.getElementById('submit-btn').textContent = 'Update User';
            document.getElementById('clear-btn').style.display = 'block';
            document.getElementById('password-help').style.display = 'block';
            document.getElementById('password').required = false;
            
            // Set form action for update
            document.getElementById('user-form').setAttribute('hx-post', '/settings/users/update');
        }
        
        function clearUserForm() {
            // Reset form fields
            document.getElementById('user-form').reset();
            document.getElementById('userId').value = '';
            
            // Reset form appearance
            document.getElementById('form-title').textContent = 'Add New User';
            document.getElementById('submit-btn').textContent = 'Create User';
            document.getElementById('clear-btn').style.display = 'none';
            document.getElementById('password-help').style.display = 'none';
            document.getElementById('password').required = true;
            
            // Set form action for create
            document.getElementById('user-form').setAttribute('hx-post', '/settings/users');
        }
    </script>
</div>

<!-- Places Content Fragment -->
<div th:fragment="places-content">
    <h2>Significant Places</h2>

    <div id="place-message" class="alert" style="display: none;"></div>

    <div class="pagination-controls">
        <span>Page <span th:text="${currentPage + 1}"></span> of <span th:text="${totalPages}"></span></span>
        <div class="pagination-buttons">
            <button th:if="${currentPage > 0}" 
                    class="btn"
                    th:attr="hx-get=@{/settings/places-content(page=${currentPage - 1})}"
                    hx-target="#places-management"
                    hx-swap="innerHTML">Previous</button>
            <button th:if="${currentPage < totalPages - 1}" 
                    class="btn"
                    th:attr="hx-get=@{/settings/places-content(page=${currentPage + 1})}"
                    hx-target="#places-management"
                    hx-swap="innerHTML">Next</button>
        </div>
    </div>

    <div class="places-grid" th:if="${!isEmpty}">
        <div class="place-card" th:each="place : ${places}">
            <div class="place-map" th:id="'map-' + ${place.id()}" th:data-lat="${place.latitude()}" th:data-lng="${place.longitude()}" ></div>
            <div class="place-details">
                <form th:id="'place-form-' + ${place.id()}"  autocomplete="off"
                      th:attr="hx-post=@{/settings/places/{id}/update(id=${place.id()})}"
                      hx-swap="none">
                    <div class="form-group">
                        <label th:for="'name-' + ${place.id()}">Name</label>
                        <input type="text" th:id="'name-' + ${place.id()}" name="name" th:value="${place.name()}" required>
                    </div>
                    <div class="place-info">
                        <div><strong>Address:</strong> <span th:text="${place.address() ?: 'Not available'}"></span></div>
                        <div><strong>Category:</strong> <span th:text="${place.category() ?: 'Not categorized'}"></span></div>
                        <div><strong>Coordinates:</strong> <span th:text="${place.latitude() + ', ' + place.longitude()}"></span></div>
                    </div>
                    <button type="submit" class="btn">Update</button>
                </form>
            </div>
        </div>
    </div>
    <p th:if="${isEmpty}">No significant places found.</p>
</div>

<!-- Queue Stats Content Fragment -->
<div th:fragment="queue-stats-content">
    <h2>Job Status</h2>

    <div class="queue-status">
        <div class="queue-card" th:each="queue : ${queueStats}">
            <div class="queue-name" th:text="${queue.name()}">Queue Name</div>
            <div class="queue-count" th:text="${queue.count()}">0</div>
            <div class="queue-time" th:text="'Est. processing time: ' + ${queue.estimatedTime()}">Est. processing time: 0 min</div>
            <div class="progress-bar">
                <div class="progress-fill" th:style="'width:' + ${queue.rate()} + '%'"></div>
            </div>
        </div>
    </div>

    <div style="margin-top: 20px;">
        <button class="btn" 
                hx-get="/settings/queue-stats-content" 
                hx-target="#job-status" 
                hx-swap="innerHTML">Refresh Status</button>
    </div>
</div>

<!-- File Upload Content Fragment -->
<div th:fragment="file-upload-content">
    <h2>Import Location Data</h2>
    
    <div th:if="${uploadSuccessMessage}" class="alert alert-success" style="display: block;">
        <span th:text="${uploadSuccessMessage}">File uploaded successfully</span>
    </div>
    <div th:if="${uploadErrorMessage}" class="alert alert-danger" style="display: block;">
        <span th:text="${uploadErrorMessage}">Error message</span>
    </div>
    
    <div class="upload-options">
        <div class="upload-option">
            <h3>GPX Files</h3>
            <p class="description">
                Upload GPX files from your GPS devices or tracking apps. GPX files contain waypoints, 
                tracks, and routes with timestamps that can be processed into your location history.
            </p>
            <form id="gpx-upload-form"
                  hx-post="/settings/import/gpx"
                  hx-target="#file-upload"
                  hx-encoding="multipart/form-data">
                <div class="form-group">
                    <input type="file" name="file" accept=".gpx" required>
                </div>
                <button type="submit" class="btn">Upload GPX File</button>
            </form>
            <progress id='progress-gpx' value='0' max='100' style="display: none"></progress>
            <script>
                htmx.on('#gpx-upload-form', 'htmx:xhr:progress', function(evt) {
                    htmx.find('#progress-gpx').setAttribute('value', evt.detail.loaded/evt.detail.total * 100)
                    htmx.find('#progress-gpx').setAttribute('style', null)
                });
            </script>
        </div>
        
        <div class="upload-option">
            <h3>Google Takeout</h3>
            <p class="description">
                Upload location history from Google Takeout. Export your data from Google 
                (takeout.google.com) and upload the Location History JSON file. This contains 
                your location history with timestamps and activity information.
            </p>
            <form id="takeout-upload-form"
                  hx-post="/settings/import/google-takeout"
                  hx-target="#file-upload"
                  hx-swap="innerHTML"
                  hx-encoding="multipart/form-data">
                <div class="form-group">
                    <input type="file" name="file" accept=".json" required>
                </div>
                <button type="submit" class="btn">Upload Google Takeout</button>
            </form>
            <progress id='progress-google' value='0' max='100'  style="display: none"></progress>
            <script>
                htmx.on('#takeout-upload-form', 'htmx:xhr:progress', function(evt) {
                    htmx.find('#progress-google').setAttribute('value', evt.detail.loaded/evt.detail.total * 100)
                    htmx.find('#progress-google').setAttribute('style', null)
                });
            </script>
        </div>
    </div>
</div>

</body>
</html>
