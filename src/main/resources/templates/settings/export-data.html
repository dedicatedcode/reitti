<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{settings.title}">Settings - Reitti</title>
    <link rel="icon" th:href="@{/img/logo.svg}">
    <link rel="apple-touch-icon" th:href="@{/img/logo.svg}">
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/img/logo.svg}">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/lineicons.css">
    <script src="/js/htmx.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/gpx-downloader.js"></script>
</head>
<body class="settings-page">
<div class="navigation-container" th:replace="~{fragments/main-navigation :: main-navigation('settings')}"></div>

<div class="settings-container">
    <div th:replace="~{fragments/settings-navigation :: settings-nav(${activeSection}, ${dataManagementEnabled}, ${isAdmin})}"></div>
    <div class="settings-content-area">
        <div id="export-data" class="settings-section active">
            <div th:fragment="export-data-content">
                <h2 th:text="#{export.title}">Export Data</h2>

                <div th:if="${successMessage}" class="alert alert-success" style="display: block;">
                    <span th:text="${successMessage}">Success message</span>
                </div>
                <div th:if="${errorMessage}" class="alert alert-danger" style="display: block;">
                    <span th:text="${errorMessage}">Error message</span>
                </div>

                <div class="settings-card">
                    <h3 th:text="#{export.date.range}">Date Range</h3>

                    <div style="display: flex; gap: 15px; align-items: end; margin-bottom: 20px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="startDate" th:text="#{export.start.date}">Start Date</label>
                            <input type="date"
                                   id="startDate"
                                   name="startDate"
                                   th:value="${startDate}"
                                   hx-get="/settings/export-data/data-content"
                                   hx-target="#data-content"
                                   hx-swap="innerHTML"
                                   hx-trigger="load, change"
                                   hx-include="#endDate"
                                   hx-indicator="#loading-indicator"
                                   hx-vals='js:{"timezone": getUserTimezone()}'
                                   required>
                        </div>

                        <div class="form-group" style="margin-bottom: 0;">
                            <label for="endDate" th:text="#{export.end.date}">End Date</label>
                            <input type="date"
                                   id="endDate"
                                   name="endDate"
                                   th:value="${endDate}"
                                   hx-get="/settings/export-data/data-content"
                                   hx-target="#data-content"
                                   hx-swap="innerHTML"
                                   hx-trigger="load, change"
                                   hx-include="#startDate"
                                   hx-indicator="#loading-indicator"
                                   hx-vals='js:{"timezone": getUserTimezone()}'
                                   required>
                        </div>

                        <div style="margin-left: auto; display: flex; align-items: center; gap: 15px;">
                            <div th:if="${dataManagementEnabled}" class="form-group" style="margin-bottom: 0; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="relevantDataOnly" name="relevantDataOnly" style="margin: 0;">
                                <label for="relevantDataOnly" style="margin: 0; font-size: 14px; color: var(--color-text-white);" th:text="#{export.gpx.relevant}">Only processing relevant</label>
                            </div>
                            <button type="button" 
                                    class="btn"
                                    data-gpx-download
                                    onclick="handleGpxDownload(this)"
                                    style="display: flex; align-items: center; gap: 8px;">
                                <span th:text="#{export.gpx.button}">Export as GPX</span>
                                <div id="gpx-loading" style="display: none; height: 0; margin-left: 8px; width: 20px;">
                                    <div style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--color-accent); animation: spin 1s ease-in-out infinite;"></div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h3 th:text="#{export.raw.data.title}">Raw Location Data</h3>

                    <!-- Loading indicator -->
                    <div id="loading-indicator" style="display: none; text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--color-accent); animation: spin 1s ease-in-out infinite;"></div>
                        <p style="margin-top: 15px; color: var(--color-text-white);" th:text="#{export.raw.data.loading}">Loading location data...</p>
                    </div>

                    <div id="data-content" th:fragment="data-content">
                        <div th:if="${rawLocationPoints.isEmpty() and totalElements == 0}">
                            <p th:text="#{export.raw.data.no.data}">No location data found for the selected date range</p>
                        </div>

                        <div th:if="${totalElements > 0}">
                            <!-- Pagination controls at top -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <p style="margin: 0; color: var(--color-text-white);" 
                                       th:text="#{export.raw.data.found.data(${totalElements})}">
                                        Found 123234 location points
                                    </p>
                                    <p style="margin: 0; color: var(--color-text-muted); font-size: 14px;"
                                       th:text="|Showing ${currentPage * pageSize + 1} - ${currentPage * pageSize + rawLocationPoints.size()} of ${totalElements}|">
                                        Showing 1 - 100 of 1000
                                    </p>
                                </div>
                                
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <!-- Page size selector -->
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <label for="pageSizeSelect" style="color: var(--color-text-white); font-size: 14px;">Show:</label>
                                        <select id="pageSizeSelect" 
                                                style="background: var(--color-bg-secondary); color: var(--color-text-white); border: 1px solid var(--color-border); border-radius: 4px; padding: 4px 8px;"
                                                hx-get="/settings/export-data/data-content"
                                                hx-target="#data-content"
                                                hx-swap="innerHTML"
                                                hx-include="#startDate, #endDate"
                                                hx-vals='js:{"timezone": getUserTimezone(), "page": 0}'
                                                hx-trigger="change">
                                            <option value="100" th:selected="${pageSize == 100}">100</option>
                                            <option value="500" th:selected="${pageSize == 500}">500</option>
                                            <option value="1000" th:selected="${pageSize == 1000}">1000</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Page navigation -->
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <button type="button" 
                                                class="btn btn-sm"
                                                th:disabled="${!hasPrevious}"
                                                hx-get="/settings/export-data/data-content"
                                                hx-target="#data-content"
                                                hx-swap="innerHTML"
                                                hx-include="#startDate, #endDate, #pageSizeSelect"
                                                th:hx-vals="|js:{'timezone': getUserTimezone(), 'page': ${currentPage - 1}}|"
                                                hx-trigger="click">
                                            Previous
                                        </button>
                                        
                                        <span style="color: var(--color-text-white); font-size: 14px;"
                                              th:text="|Page ${currentPage + 1} of ${totalPages}|">
                                            Page 1 of 10
                                        </span>
                                        
                                        <button type="button" 
                                                class="btn btn-sm"
                                                th:disabled="${!hasNext}"
                                                hx-get="/settings/export-data/data-content"
                                                hx-target="#data-content"
                                                hx-swap="innerHTML"
                                                hx-include="#startDate, #endDate, #pageSizeSelect"
                                                th:hx-vals="|js:{'timezone': getUserTimezone(), 'page': ${currentPage + 1}}|"
                                                hx-trigger="click">
                                            Next
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="export-data-table-container">
                                <table>
                                    <thead>
                                    <tr>
                                        <th th:text="#{export.raw.data.table.timestamp}">Timestamp</th>
                                        <th th:text="#{export.raw.data.table.latitude}">Latitude</th>
                                        <th th:text="#{export.raw.data.table.longitude}">Longitude</th>
                                        <th th:text="#{export.raw.data.table.accuracy}">Accuracy (m)</th>
                                        <th th:text="#{export.raw.data.table.processed}">Processed</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="point : ${rawLocationPoints}" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <td th:text="${#temporals.format(point.timestamp(), 'yyyy-MM-dd HH:mm:ss')}">2024-01-01 12:00:00</td>
                                        <td th:text="${#numbers.formatDecimal(point.latitude(), 1, 6)}">60.123456</td>
                                        <td th:text="${#numbers.formatDecimal(point.longitude(), 1, 6)}">24.123456</td>
                                        <td th:text="${point.accuracyMeters != null ? #numbers.formatDecimal(point.accuracyMeters(), 1, 1) : 'N/A'}">10.0</td>
                                        <td>
                                            <span th:if="${point.processed()}" style="color: #28a745;">✓</span>
                                            <span th:unless="${point.processed()}" style="color: #ffc107;">○</span>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination controls at bottom -->
                            <div style="display: flex; justify-content: center; margin-top: 15px;" th:if="${totalPages > 1}">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <button type="button" 
                                            class="btn btn-sm"
                                            th:disabled="${!hasPrevious}"
                                            hx-get="/settings/export-data/data-content"
                                            hx-target="#data-content"
                                            hx-swap="innerHTML"
                                            hx-include="#startDate, #endDate, #pageSizeSelect"
                                            th:hx-vals="|js:{'timezone': getUserTimezone(), 'page': ${currentPage - 1}}|"
                                            hx-trigger="click">
                                        Previous
                                    </button>
                                    
                                    <span style="color: var(--color-text-white); font-size: 14px;"
                                          th:text="|Page ${currentPage + 1} of ${totalPages}|">
                                        Page 1 of 10
                                    </span>
                                    
                                    <button type="button" 
                                            class="btn btn-sm"
                                            th:disabled="${!hasNext}"
                                            hx-get="/settings/export-data/data-content"
                                            hx-target="#data-content"
                                            hx-swap="innerHTML"
                                            hx-include="#startDate, #endDate, #pageSizeSelect"
                                            th:hx-vals="|js:{'timezone': getUserTimezone(), 'page': ${currentPage + 1}}|"
                                            hx-trigger="click">
                                        Next
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script th:inline="javascript">
        window.userSettings = /*[[${userSettings}]]*/ {}
        
        function handleGpxDownload(buttonElement) {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const relevantDataCheckbox = document.getElementById('relevantDataOnly');
            const relevantData = relevantDataCheckbox ? relevantDataCheckbox.checked : false;

            gpxDownloader.downloadGpx(startDate, endDate, buttonElement, relevantData);
        }
    </script>
</div>
</body>
