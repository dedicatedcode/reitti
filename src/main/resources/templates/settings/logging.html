<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{settings.title}">Settings - Reitti</title>
    <link rel="icon" th:href="@{/img/logo.svg}">
    <link rel="apple-touch-icon" th:href="@{/img/logo.svg}">
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/img/logo.svg}">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/lineicons.css}">
    <script th:src="@{/js/htmx.min.js}"></script>
    <script th:src="@{/js/util.js}"></script>
    <style>
        .log-output {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 5px;
            height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .log-line {
            margin: 0;
            padding: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .log-line:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.02);
        }
        
        .log-line.warn {
            color: #ffa500;
        }
        
        .log-line.error {
            color: #ff6b6b;
        }
        
        .log-line.fatal {
            color: #ff0000;
            font-weight: bold;
        }
        
        .htmx-indicator {
            display: none;
        }
        
        .htmx-request .htmx-indicator {
            display: inline;
        }

        .autoscroll-control {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .logger-name {
            font-weight: bold;
            font-family: monospace;
        }
        
        .logger-level-select {
            min-width: 100px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.875em;
            margin-right: 5px;
        }
        
        .logger-level-form {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body class="settings-page">
<div class="navigation-container" th:replace="~{fragments/main-navigation :: main-navigation('settings')}"></div>
<div class="settings-container">
    <div th:replace="~{fragments/settings-navigation :: settings-nav(${activeSection}, ${dataManagementEnabled}, ${isAdmin})}"></div>
    <div class="settings-content-area">

        <div id="logging" class="settings-section active">
            <div th:fragment="logging-content">
                <h2 th:text="#{logging.title}">Log Viewer</h2>
                <div class="settings-card">
                    <div class="autoscroll-control">
                        <input type="checkbox" id="autoscrollToggle" checked>
                        <label for="autoscrollToggle" th:text="#{logging.autoscroll}">Auto-scroll to new messages</label>
                    </div>
                    <div class="log-output" id="logOutput">
                        <div class="log-line" th:text="#{logging.connecting}">Connecting to log stream...</div>
                    </div>
                </div>
                <div id="statusMessage" class="alert alert-success" style="display: none"></div>

                <div id="loggingSettingsCard" th:fragment="logging-settings-card" class="settings-card">
                    <form id="loggingSettingsForm"
                          th:hx-post="@{/settings/logging/update}"
                          hx-target="#loggingSettingsCard"
                          hx-swap="outerHTML">
                        <div class="form-group">
                            <label for="loggerClass" th:text="#{logging.logger.class}">Logger Class:</label>
                            <input type="text" id="loggerClass" name="logger" class="input-field"
                                   th:placeholder="#{logging.logger.placeholder}">
                            <small class="form-text" th:text="#{logging.logger.help}">Leave empty to configure the root (global) logger</small>
                        </div>

                        <div class="form-group">
                            <label for="logLevel" th:text="#{logging.log.level}">Log Level:</label>
                            <select id="logLevel" name="level" class="select-field">
                                <option value="TRACE" th:text="#{logging.level.trace}" th:selected="${currentLogLevel == 'TRACE'}">TRACE</option>
                                <option value="DEBUG" th:text="#{logging.level.debug}" th:selected="${currentLogLevel == 'DEBUG'}">DEBUG</option>
                                <option value="INFO" th:text="#{logging.level.info}" th:selected="${currentLogLevel == 'INFO'}">INFO</option>
                                <option value="WARN" th:text="#{logging.level.warn}" th:selected="${currentLogLevel == 'WARN'}">WARN</option>
                                <option value="ERROR" th:text="#{logging.level.error}" th:selected="${currentLogLevel == 'ERROR'}">ERROR</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="bufferSize" th:text="#{logging.buffer.size}">Buffer Size:</label>
                            <input type="number" id="bufferSize" name="size" class="input-field"
                                   th:value="${currentBufferSize}"
                                   th:max="${maxBufferSize}"
                                   min="100" step="100">
                            <small class="form-text" th:text="#{logging.buffer.max.size(${maxBufferSize})}">Max buffer size: 10000</small>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                <span th:text="#{logging.update}">Update</span>
                                <span class="htmx-indicator">...</span>
                            </button>
                        </div>
                    </form>
                    <h3 th:text="#{logging.configured.loggers}">Configured Loggers</h3>
                    <table>
                        <thead>
                        <tr>
                            <th th:text="#{logging.log.name}">Logger Name</th>
                            <th th:text="#{logging.log.level}">Log Level</th>
                            <th th:text="#{logging.actions}">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="logger : ${configuredLoggers}">
                            <td>
                                <span class="logger-name" th:text="${logger.name}">Logger Name</span>
                            </td>
                            <td>
                                <form class="logger-level-form"
                                      th:hx-post="@{/settings/logging/update}"
                                      hx-target="#loggingSettingsCard"
                                      hx-swap="outerHTML">
                                    <input type="hidden" name="logger" th:value="${logger.name}">
                                    <input type="hidden" name="size" th:value="${currentBufferSize}">
                                    <select class="select-field logger-level-select" name="level">
                                        <option value="TRACE" th:text="#{logging.level.trace}" th:selected="${logger.level == 'TRACE'}">TRACE</option>
                                        <option value="DEBUG" th:text="#{logging.level.debug}" th:selected="${logger.level == 'DEBUG'}">DEBUG</option>
                                        <option value="INFO" th:text="#{logging.level.info}" th:selected="${logger.level == 'INFO'}">INFO</option>
                                        <option value="WARN" th:text="#{logging.level.warn}" th:selected="${logger.level == 'WARN'}">WARN</option>
                                        <option value="ERROR" th:text="#{logging.level.error}" th:selected="${logger.level == 'ERROR'}">ERROR</option>
                                    </select>
                                    <button type="submit" class="btn btn-secondary">
                                        <span th:text="#{logging.update}">Update</span>
                                        <span class="htmx-indicator">...</span>
                                    </button>
                                </form>
                            </td>
                            <td>
                                <button type="button" class="btn btn-danger"
                                        th:if="${logger.name != 'ROOT'}"
                                        th:hx-post="@{/settings/logging/remove}"
                                        th:hx-vals="${'{&quot;logger&quot;:&quot;' + logger.name + '&quot;}'}"
                                        hx-target="#loggingSettingsCard"
                                        hx-swap="outerHTML"
                                        th:hx-confirm="#{logging.confirm.remove}">
                                    <span th:text="#{logging.remove}">Remove</span>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>


            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    window.contextPath = /*[[@{/}]]*/ "/";
    window.contextPath = window.contextPath.replace(/\/$/, '');
    window.userSettings = /*[[${userSettings}]]*/ {}
    
    // Localized messages
    const messages = {
        connected: /*[[#{logging.connected}]]*/ 'Connected to log stream',
        connectionLost: /*[[#{logging.connection.lost}]]*/ 'Error: Connection to log stream lost',
        reconnecting: /*[[#{logging.reconnecting}]]*/ 'Attempting to reconnect in',
        reconnectFailed: /*[[#{logging.reconnect.failed}]]*/ 'Failed to reconnect after'
    };
    
    const logOutput = document.getElementById('logOutput');
    const autoscrollToggle = document.getElementById('autoscrollToggle');
    let eventSource;
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 50;
    let reconnectTimeout;
    
    function shouldAutoscroll() {
        return autoscrollToggle.checked;
    }
    
    function scrollToBottom() {
        if (shouldAutoscroll()) {
            logOutput.scrollTop = logOutput.scrollHeight;
        }
    }
    
    function addLogLevelClass(logHtml) {
        if (logHtml.includes('[WARN]')) {
            return logHtml.replace('<div class="log-line">', '<div class="log-line warn">');
        } else if (logHtml.includes('[ERROR]')) {
            return logHtml.replace('<div class="log-line">', '<div class="log-line error">');
        } else if (logHtml.includes('[FATAL]')) {
            return logHtml.replace('<div class="log-line">', '<div class="log-line fatal">');
        }
        return logHtml;
    }
    
    function connectEventSource() {
        eventSource = new EventSource(window.contextPath + '/settings/logging/stream');
        
        eventSource.onopen = function() {
            logOutput.innerHTML = `<div class="log-line">${messages.connected}</div>`;
            scrollToBottom();
            reconnectAttempts = 0;
        };
        
        eventSource.addEventListener('log', function(event) {
            const coloredLogHtml = addLogLevelClass(event.data);
            logOutput.insertAdjacentHTML('beforeend', coloredLogHtml);
            scrollToBottom();
        });
        
        eventSource.onerror = function(event) {
            logOutput.innerHTML += `<div class="log-line error">${messages.connectionLost}</div>`;
            scrollToBottom();
            
            eventSource.close();
            
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 30000);
                logOutput.innerHTML += `<div class="log-line">${messages.reconnecting} ${delay / 1000} seconds... (attempt ${reconnectAttempts}/${maxReconnectAttempts})</div>`;
                scrollToBottom();
                
                reconnectTimeout = setTimeout(connectEventSource, delay);
            } else {
                logOutput.innerHTML += `<div class="log-line error">${messages.reconnectFailed} ${maxReconnectAttempts} attempts. Please refresh the page.</div>`;
                scrollToBottom();
            }
        };
    }
    
    connectEventSource();
    
    window.addEventListener('beforeunload', function() {
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
        }
        if (eventSource) {
            eventSource.close();
        }
    });
    
    
</script>
</body>
</html>
