<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{settings.title}">Settings - Reitti</title>
    <link rel="icon" th:href="@{/img/logo.svg}">
    <link rel="apple-touch-icon" th:href="@{/img/logo.svg}">
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/img/logo.svg}">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/lineicons.css">
    <script src="/js/htmx.min.js"></script>
    <script src="/js/util.js"></script>
    <style>
        .log-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .log-controls label {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .log-controls select,
        .log-controls input[type="text"],
        .log-controls input[type="number"],
        .log-controls button {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .log-controls button {
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        
        .log-controls button:hover {
            background: #0056b3;
        }
        
        .log-output {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 5px;
            height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        
        .log-line {
            margin: 0;
            padding: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .log-line:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.02);
        }
        
        .log-line.warn {
            color: #ffa500;
        }
        
        .log-line.error {
            color: #ff6b6b;
        }
        
        .log-line.fatal {
            color: #ff0000;
            font-weight: bold;
        }
        
        .htmx-indicator {
            display: none;
        }
        
        .htmx-request .htmx-indicator {
            display: inline;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .autoscroll-control {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body class="settings-page">
<div class="navigation-container" th:replace="~{fragments/main-navigation :: main-navigation('settings')}"></div>
<div class="settings-container">
    <div th:replace="~{fragments/settings-navigation :: settings-nav(${activeSection}, ${dataManagementEnabled}, ${isAdmin})}"></div>
    <div class="settings-content-area">
        <div id="logging" class="settings-section active">
            <div th:fragment="logging-content">
                <h2>Log Viewer</h2>

                <div id="statusMessage" class="status-message"></div>

                <div class="settings-card">
                    <div class="log-controls">
                        <div>
                            <label for="loggerClass">Logger Class:</label>
                            <input type="text" id="loggerClass" name="logger" 
                                   placeholder="Leave empty for ROOT logger"
                                   style="width: 200px;">
                        </div>
                        
                        <div>
                            <label for="logLevel">Log Level:</label>
                            <select id="logLevel" name="level"
                                    hx-post="/settings/logging/level"
                                    hx-trigger="change"
                                    hx-include="#loggerClass"
                                    hx-swap="none"
                                    hx-on="htmx:afterRequest: handleResponse(event)">
                                <option value="TRACE">TRACE</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO" selected>INFO</option>
                                <option value="WARN">WARN</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="bufferSize">Buffer Size:</label>
                            <input type="number" id="bufferSize" name="size" 
                                   th:value="${currentBufferSize}"
                                   th:max="${maxBufferSize}"
                                   min="100" step="100">
                            <button class="btn" type="button"
                                    hx-post="/settings/logging/buffer"
                                    hx-include="#bufferSize"
                                    hx-swap="none"
                                    hx-on="htmx:afterRequest: handleResponse(event)">
                                Update Buffer
                                <span class="htmx-indicator">...</span>
                            </button>
                        </div>
                        
                        <div>
                            <small th:text="'Max buffer size: ' + ${maxBufferSize}">Max buffer size: 10000</small>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="autoscroll-control">
                        <input type="checkbox" id="autoscrollToggle" checked>
                        <label for="autoscrollToggle">Auto-scroll to new messages</label>
                    </div>
                    <div class="log-output" id="logOutput">
                        <div class="log-line">Connecting to log stream...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    window.userSettings = /*[[${userSettings}]]*/ {}
    
    function handleResponse(event) {
        const statusDiv = document.getElementById('statusMessage');
        
        if (event.detail.xhr.status === 200) {
            statusDiv.textContent = 'Settings updated successfully';
            statusDiv.className = 'status-message status-success';
            statusDiv.style.display = 'block';
        } else {
            statusDiv.textContent = 'Error: ' + event.detail.xhr.responseText;
            statusDiv.className = 'status-message status-error';
            statusDiv.style.display = 'block';
        }
        
        // Hide message after 3 seconds
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
    }
    
    // Set up SSE connection for log streaming
    const logOutput = document.getElementById('logOutput');
    const autoscrollToggle = document.getElementById('autoscrollToggle');
    const eventSource = new EventSource('/settings/logging/stream');
    
    function shouldAutoscroll() {
        return autoscrollToggle.checked;
    }
    
    function scrollToBottom() {
        if (shouldAutoscroll()) {
            logOutput.scrollTop = logOutput.scrollHeight;
        }
    }
    
    function addLogLevelClass(logHtml) {
        // Add CSS classes based on log level
        if (logHtml.includes('[WARN]')) {
            return logHtml.replace('<div class="log-line">', '<div class="log-line warn">');
        } else if (logHtml.includes('[ERROR]')) {
            return logHtml.replace('<div class="log-line">', '<div class="log-line error">');
        } else if (logHtml.includes('[FATAL]')) {
            return logHtml.replace('<div class="log-line">', '<div class="log-line fatal">');
        }
        return logHtml;
    }
    
    eventSource.onopen = function() {
        logOutput.innerHTML = '<div class="log-line">Connected to log stream</div>';
        scrollToBottom();
    };
    
    eventSource.addEventListener('log', function(event) {
        const coloredLogHtml = addLogLevelClass(event.data);
        logOutput.insertAdjacentHTML('beforeend', coloredLogHtml);
        scrollToBottom();
    });
    
    eventSource.onerror = function(event) {
        logOutput.innerHTML += '<div class="log-line error">Error: Connection to log stream lost</div>';
        scrollToBottom();
    };
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        eventSource.close();
    });
</script>
</body>
</html>
