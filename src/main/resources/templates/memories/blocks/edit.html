<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Block - Reitti</title>
    <link rel="icon" th:href="@{/img/logo.svg}">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/memories.css">
    <link rel="stylesheet" href="/css/lineicons.css">
</head>
<body class="memories-page">
<div class="settings-container">
    <nav class="settings-nav">
        <div class="settings-header">
            <a th:href="@{/memories/{id}(id=${memoryId})}" class="back-link">
                <i class="lni lni-arrow-left"></i>
                <span>Back to Memory</span>
            </a>
            <h1>Edit Block</h1>
        </div>
    </nav>
    
    <div class="settings-content-area">
        <div th:fragment="edit-text-block" th:if="${block.blockType.name() == 'TEXT'}" class="memory-form">
            <h2>Edit Text Block</h2>
            <form th:attr="hx-post=@{/memories/{memoryId}/blocks/{blockId}/text(memoryId=${memoryId}, blockId=${block.id})}" hx-target="closest .memory-block" hx-swap="innerHTML" hx-vals="js:{timezone: getUserTimezone()}">
                <div class="form-group">
                    <label for="headline">Headline</label>
                    <input type="text" id="headline" name="headline" class="form-control" 
                           th:value="${textBlock?.headline}" placeholder="Enter headline">
                </div>
                <div class="form-group">
                    <label for="content">Content</label>
                    <textarea id="content" name="content" class="form-control" rows="10" 
                              placeholder="Enter content" th:text="${textBlock?.content}"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" 
                            th:attr="hx-get=@{/memories/{memoryId}/blocks/{blockId}/view(memoryId=${memoryId}, blockId=${block.id})}"
                            hx-target="closest .memory-block" 
                            hx-swap="innerHTML" 
                            class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
        <div th:fragment="edit-cluster-trip-block" th:if="${block.blockType.name() == 'CLUSTER_TRIP'}" class="memory-form">
            <h2>Edit Trips Block</h2>
            <form th:attr="hx-post=@{/memories/{memoryId}/blocks/{blockId}/cluster-trips(memoryId=${memoryId}, blockId=${block.id})}" hx-target="closest .memory-block" hx-swap="innerHTML" hx-vals="js:{timezone: getUserTimezone()}">
                <div class="form-group">
                    <label>Select Trips</label>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Selected</th>
                                <th>Trip</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="trip : ${availableTrips}">
                                <td>
                                    <input type="checkbox"
                                           name="selectedTrips" 
                                           th:value="${trip.id}" 
                                           th:checked="${clusterTripBlock.trips != null and clusterTripBlock.trips.contains(trip)}">
                                </td>
                                <td th:text="${#temporals.format(trip.startTime, 'MMM d, yyyy HH:mm')} + ' (' + ${trip.startVisit != null and trip.startVisit.place != null ? trip.startVisit.place.name : 'Unknown'} + ') -> ' + ${#temporals.format(trip.endTime, 'HH:mm')} + ' (' + ${trip.endVisit != null and trip.endVisit.place != null ? trip.endVisit.place.name : 'Unknown'} + ')'">Trip details</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="form-actions">
                    <button type="button"
                            th:attr="hx-get=@{/memories/{memoryId}/blocks/{blockId}/view(memoryId=${memoryId}, blockId=${block.id})}"
                            hx-target="closest .memory-block"
                            hx-swap="innerHTML"
                            class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>

        <div th:if="${block.blockType.name() == 'IMAGE_GALLERY'}" class="memory-form">
            <h2>Edit Image Gallery</h2>
            
            <div class="images-list" th:if="${images != null && !images.isEmpty()}">
                <div th:each="image : ${images}" class="image-item">
                    <img th:src="${image.imageUrl}" alt="Gallery image" class="gallery-thumbnail">
                    <input type="text" th:value="${image.caption}" class="form-control" placeholder="Caption">
                    <form th:action="@{/memories/{memoryId}/blocks/{blockId}/images/{imageId}(memoryId=${memoryId}, blockId=${block.id}, imageId=${image.id})}" 
                          method="post" style="display: inline;">
                        <input type="hidden" name="_method" value="DELETE">
                        <button type="submit" class="btn-icon danger" onclick="return confirm('Delete this image?')">
                            <i class="lni lni-trash"></i>
                        </button>
                    </form>
                </div>
            </div>

            <form th:action="@{/memories/{memoryId}/blocks/{blockId}/images(memoryId=${memoryId}, blockId=${block.id})}" method="post">
                <div class="form-group">
                    <label for="imageUrl">Add Image URL</label>
                    <input type="url" id="imageUrl" name="imageUrl" class="form-control" 
                           placeholder="https://example.com/image.jpg" required>
                </div>

                <div class="form-group">
                    <label for="caption">Caption</label>
                    <input type="text" id="caption" name="caption" class="form-control" 
                           placeholder="Image caption (optional)">
                </div>

                <div class="form-actions">
                    <button type="button" 
                            hx-get="@{/memories/{memoryId}/blocks/{blockId}/view(memoryId=${memoryId}, blockId=${block.id})}" 
                            hx-target="closest .memory-block" 
                            hx-swap="innerHTML" 
                            class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Image</button>
                </div>
            </form>
        </div>

        <div th:if="${block.blockType.name() == 'VISIT'}" class="memory-form">
            <h2>Visit Block</h2>
            <p>Visit blocks are automatically populated from your timeline data.</p>
            <div class="form-actions">
                <button type="button" 
                        hx-get="@{/memories/{memoryId}/blocks/{blockId}/view(memoryId=${memoryId}, blockId=${block.id})}" 
                        hx-target="closest .memory-block" 
                        hx-swap="innerHTML" 
                        class="btn btn-secondary">Cancel</button>
            </div>
        </div>

        <div th:if="${block.blockType.name() == 'TRIP'}" class="memory-form">
            <h2>Trip Block</h2>
            <p>Trip blocks are automatically populated from your timeline data.</p>
            <div class="form-actions">
                <button type="button" 
                        hx-get="@{/memories/{memoryId}/blocks/{blockId}/view(memoryId=${memoryId}, blockId=${block.id})}" 
                        hx-target="closest .memory-block" 
                        hx-swap="innerHTML" 
                        class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>
</body>
</html>
