<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
</head>
<body>

<!-- Block type selection fragment -->
<div th:fragment="block-type-selection" class="block-type-selection">
    <h3 th:text="#{memory.block.select.type}">Select Block Type</h3>
    <div class="block-type-grid">
        <button type="button" 
                class="block-type-option"
                th:attr="hx-get=@{/memories/{id}/blocks/new(id=${memoryId}, type='TEXT')}"
                hx-target=".blocks-add-area"
                hx-swap="innerHTML">
            <span th:text="#{memory.block.type.text}">Text Block</span>
            <p th:text="#{memory.block.type.text.description}">Add text content with headlines and paragraphs</p>
        </button>
        
        <button type="button" 
                class="block-type-option"
                th:attr="hx-get=@{/memories/{id}/blocks/new(id=${memoryId}, type='VISIT')}"
                hx-target=".blocks-add-area"
                hx-swap="innerHTML">
            <span th:text="#{memory.block.type.visit}">Visit Block</span>
            <p th:text="#{memory.block.type.visit.description}">Add a location you visited during this memory</p>
        </button>
        
        <button type="button" 
                class="block-type-option"
                th:attr="hx-get=@{/memories/{id}/blocks/new(id=${memoryId}, type='TRIP')}"
                hx-target=".blocks-add-area"
                hx-swap="innerHTML">
            <span th:text="#{memory.block.type.trip}">Trip Block</span>
            <p th:text="#{memory.block.type.trip.description}">Add a journey or route from this memory</p>
        </button>
        
        <button type="button" 
                class="block-type-option"
                th:attr="hx-get=@{/memories/{id}/blocks/new(id=${memoryId}, type='IMAGE_GALLERY')}"
                hx-target=".blocks-add-area"
                hx-swap="innerHTML">
            <span th:text="#{memory.block.type.gallery}">Image Gallery</span>
            <p th:text="#{memory.block.type.gallery.description}">Add a collection of photos from this memory</p>
        </button>
    </div>
    
    <div class="form-actions">
        <button type="button" 
                class="btn btn-secondary"
                hx-get="/memories/fragments/empty"
                hx-target=".blocks-add-area"
                hx-swap="innerHTML"
                th:text="#{memory.block.cancel}">Cancel</button>
    </div>
</div>

<!-- Empty fragment for clearing content -->
<div th:fragment="empty"></div>

<!-- Text block form -->
<div th:fragment="text-block-form" class="block-form">
    <h3 th:text="#{memory.block.text.new}">Add Text Block</h3>
    <form th:action="@{/memories/{id}/blocks/text(id=${memoryId})}" method="post" hx-target="body" hx-swap="innerHTML">
        
        <div class="form-group">
            <label for="headline" th:text="#{memory.block.text.headline}">Headline</label>
            <input type="text" id="headline" name="headline" class="form-control" th:placeholder="#{memory.block.text.headline.placeholder}">
        </div>
        
        <div class="form-group">
            <label for="content" th:text="#{memory.block.text.content}">Content</label>
            <textarea id="content" name="content" class="form-control" rows="6" th:placeholder="#{memory.block.text.content.placeholder}"></textarea>
        </div>
        
        <div class="form-actions">
            <button type="button" 
                    class="btn btn-secondary"
                    hx-get="/memories/fragments/empty"
                    hx-target=".blocks-add-area"
                    hx-swap="innerHTML"
                    th:text="#{memory.block.cancel}">Cancel</button>
            <button type="submit" class="btn btn-primary" th:text="#{memory.block.create}">Save Block</button>
        </div>
    </form>
</div>

<!-- Visit block form -->
<div th:fragment="visit-block-form" class="block-form">
    <h3 th:text="#{memory.block.visit.new}">Add Visit Block</h3>
    <form th:action="@{/memories/{id}/blocks/visit(id=${memoryId})}" method="post" hx-target="body" hx-swap="innerHTML">
        
        <div class="form-group">
            <label for="visitId" th:text="#{memory.block.visit.select}">Select Visit</label>
            <select id="visitId" name="visitId" class="form-control" required>
                <option value="" th:text="#{memory.block.visit.select.placeholder}">Choose a visit...</option>
            </select>
        </div>
        
        <div class="form-actions">
            <button type="button" 
                    class="btn btn-secondary"
                    hx-get="/memories/fragments/empty"
                    hx-target=".blocks-add-area"
                    hx-swap="innerHTML"
                    th:text="#{memory.block.cancel}">Cancel</button>
            <button type="submit" class="btn btn-primary" th:text="#{memory.block.create}">Save Block</button>
        </div>
    </form>
</div>

<!-- Trip block form -->
<div th:fragment="trip-block-form" class="block-form">
    <h3 th:text="#{memory.block.trip.new}">Add Trip Block</h3>
    <form th:action="@{/memories/{id}/blocks/trip(id=${memoryId})}" method="post" hx-target="body" hx-swap="innerHTML">
        
        <div class="form-group">
            <label for="tripId" th:text="#{memory.block.trip.select}">Select Trip</label>
            <select id="tripId" name="tripId" class="form-control" required>
                <option value="" th:text="#{memory.block.trip.select.placeholder}">Choose a trip...</option>
            </select>
        </div>
        
        <div class="form-actions">
            <button type="button" 
                    class="btn btn-secondary"
                    hx-get="/memories/fragments/empty"
                    hx-target=".blocks-add-area"
                    hx-swap="innerHTML"
                    th:text="#{memory.block.cancel}">Cancel</button>
            <button type="submit" class="btn btn-primary" th:text="#{memory.block.create}">Save Block</button>
        </div>
    </form>
</div>

<!-- Image gallery block form -->
<div th:fragment="image-gallery-block-form" class="block-form gallery-block-form">
    <h3 th:text="#{memory.block.gallery.new}">New Image Gallery Block</h3>
    
    <div class="gallery-panels">
        <!-- Immich Panel -->
        <div class="gallery-panel immich-panel" th:if="${immichEnabled}">
            <h4 th:text="#{memory.block.gallery.immich.title}">Select from Immich</h4>
            <div class="immich-photos-container">
                <div class="immich-photos-grid" 
                     id="immichPhotosGrid"
                     th:attr="hx-get=@{/memories/{id}/blocks/immich-photos(id=${memoryId},page=0)}"
                     hx-trigger="load"
                     hx-swap="outerHTML">
                    <div class="loading" th:text="#{memory.block.gallery.loading}">Loading photos...</div>
                </div>
                <div class="immich-pagination" id="immichPagination"></div>
            </div>
            <div class="selected-immich-photos" id="selectedImmichPhotos">
                <h5 th:text="#{memory.block.gallery.immich.selected}">Selected Photos</h5>
                <div class="selected-photos-list" id="selectedPhotosList"></div>
            </div>
        </div>

        <!-- File Upload Panel -->
        <div class="gallery-panel upload-panel">
            <h4 th:text="#{memory.block.gallery.upload.title}">Upload Images</h4>
            <div class="upload-area">
                <form id="uploadForm" 
                      th:attr="hx-post=@{/memories/{id}/blocks/upload-image(id=${memoryId})}"
                      hx-encoding="multipart/form-data"
                      hx-target="#uploadedFilesList"
                      hx-swap="beforeend">
                    <input type="file" 
                           id="fileInput" 
                           name="file" 
                           accept="image/*" 
                           class="form-control"
                           onchange="this.form.dispatchEvent(new Event('submit', {bubbles: true, cancelable: true}))">
                    <label for="fileInput" class="upload-label">
                        <i class="lni lni-cloud-upload"></i>
                        <span th:text="#{memory.block.gallery.upload.choose}">Choose file or drag here</span>
                    </label>
                </form>
            </div>
            <div class="uploaded-files" id="uploadedFiles">
                <h5 th:text="#{memory.block.gallery.upload.files}">Uploaded Files</h5>
                <div class="uploaded-files-list" id="uploadedFilesList"></div>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="button" 
                class="btn btn-primary" 
                onclick="createGalleryBlock()"
                th:text="#{memory.block.create}">Create Gallery Block</button>
        <button type="button"
                class="btn btn-secondary"
                th:attr="hx-get=@{/memories/fragments/empty}"
                hx-target=".blocks-add-area"
                hx-swap="innerHTML"
                th:text="#{memory.block.cancel}">Cancel</button>
    </div>

    <script th:inline="javascript">
        // Initialize gallery block state
        if (typeof window.galleryBlockState === 'undefined') {
            window.galleryBlockState = {
                memoryId: /*[[${memoryId}]]*/ 0,
                selectedImmichPhotos: new Map(), // Changed to Map to store thumbnailUrl with assetId
                uploadedFiles: [],
                currentPage: 0,
                totalPages: 0
            };
        }

        function toggleImmichPhoto(assetId, thumbnailUrl) {
            if (window.galleryBlockState.selectedImmichPhotos.has(assetId)) {
                // Deselect
                window.galleryBlockState.selectedImmichPhotos.delete(assetId);
                
                // Only try to remove class if element exists
                const photoItem = document.querySelector(`[data-asset-id="${assetId}"]`);
                if (photoItem) {
                    photoItem.classList.remove('selected');
                }
                
                const selectedItem = document.querySelector(`#selected-${assetId}`);
                if (selectedItem) {
                    selectedItem.remove();
                }
            } else {
                // Select
                window.galleryBlockState.selectedImmichPhotos.set(assetId, thumbnailUrl);
                
                // Only try to add class if element exists
                const photoItem = document.querySelector(`[data-asset-id="${assetId}"]`);
                if (photoItem) {
                    photoItem.classList.add('selected');
                }
                
                const selectedList = document.getElementById('selectedPhotosList');
                const photoDiv = document.createElement('div');
                photoDiv.id = `selected-${assetId}`;
                photoDiv.className = 'selected-photo-item';
                photoDiv.innerHTML = `
                    <img src="${thumbnailUrl}" alt="Selected photo">
                    <button type="button" class="btn-remove" onclick="toggleImmichPhoto('${assetId}', '${thumbnailUrl}')">
                        <i class="lni lni-ban-2"></i>
                    </button>
                `;
                selectedList.appendChild(photoDiv);
            }
        }

        function removeUploadedFile(index) {
            window.galleryBlockState.uploadedFiles.splice(index, 1);
            renderUploadedFiles();
        }

        function renderUploadedFiles() {
            const list = document.getElementById('uploadedFilesList');
            list.innerHTML = '';
            window.galleryBlockState.uploadedFiles.forEach((file, index) => {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'uploaded-file-item';
                fileDiv.innerHTML = `
                    <img src="${file.url}" alt="${file.name}">
                    <span>${file.name}</span>
                    <button type="button" class="btn-remove" onclick="removeUploadedFile(${index})">
                        <i class="lni lni-ban-2"></i>
                    </button>
                `;
                list.appendChild(fileDiv);
            });
        }

        function loadImmichPage(page) {
            window.galleryBlockState.currentPage = page;
            htmx.ajax('GET', `/memories/${window.galleryBlockState.memoryId}/blocks/immich-photos?page=${page}`, {
                target: '.immich-photos-grid',
                swap: 'outerHTML'
            });
        }

        function createGalleryBlock() {
            const images = [];
            
            // Add selected Immich photos
            window.galleryBlockState.selectedImmichPhotos.forEach((thumbnailUrl, assetId) => {
                images.push({
                    type: 'immich',
                    assetId: assetId
                });
            });
            
            // Add uploaded files
            window.galleryBlockState.uploadedFiles.forEach(file => {
                images.push({
                    type: 'upload',
                    url: file.url,
                    name: file.name
                });
            });

            if (images.length === 0) {
                alert(/*[[#{memory.block.gallery.error.no.images}]]*/ 'Please select or upload at least one image');
                return;
            }

            // Submit the gallery block creation
            fetch(`/memories/${window.galleryBlockState.memoryId}/blocks/image-gallery`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ images: images })
            }).then(response => {
                if (response.ok) {
                    window.location.href = `/memories/${window.galleryBlockState.memoryId}`;
                } else {
                    alert(/*[[#{memory.block.gallery.error.create}]]*/ 'Failed to create gallery block');
                }
            });
        }

        // Handle file upload response
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'uploadedFilesList') {
                const response = JSON.parse(event.detail.xhr.response);
                window.galleryBlockState.uploadedFiles.push(response);
                renderUploadedFiles();
                document.getElementById('fileInput').value = '';
            }
        });
    </script>
</div>

<!-- Immich photos grid fragment -->
<div class="immich-photos-grid" th:fragment="immich-photos-grid">
    <div th:if="${photos.isEmpty()}" class="no-photos" th:text="#{memory.block.gallery.immich.no.photos}">
        No photos found for this date range
    </div>
    <div th:each="photo : ${photos}" 
         class="immich-photo-item"
         th:attr="data-asset-id=${photo.id},data-thumbnail-url=${photo.thumbnailUrl}">
        <img th:src="${photo.thumbnailUrl}" th:alt="${photo.fileName}">
        <div class="photo-overlay">
            <i class="lni lni-check-circle-1"></i>
        </div>
    </div>
    
    <script th:inline="javascript">
        (function() {
            const pageTotalPages = /*[[${totalPages}]]*/ 0;
            const pageCurrentPage = /*[[${currentPage}]]*/ 0;
            
            // Update global state
            if (window.galleryBlockState) {
                window.galleryBlockState.totalPages = pageTotalPages;
                window.galleryBlockState.currentPage = pageCurrentPage;
            }
            
            // Attach click handlers to photo items and restore selected state
            document.querySelectorAll('.immich-photo-item').forEach(item => {
                const assetId = item.getAttribute('data-asset-id');
                const thumbnailUrl = item.getAttribute('data-thumbnail-url');
                
                // Restore selected state if this photo was previously selected
                if (window.galleryBlockState && window.galleryBlockState.selectedImmichPhotos.has(assetId)) {
                    item.classList.add('selected');
                }
                
                item.addEventListener('click', function() {
                    toggleImmichPhoto(assetId, thumbnailUrl);
                });
            });
            
            // Update pagination
            const pagination = document.getElementById('immichPagination');
            if (pagination) {
                pagination.innerHTML = '';
                
                if (pageTotalPages > 1) {
                    const paginationDiv = document.createElement('div');
                    paginationDiv.className = 'pagination-controls';
                    
                    if (pageCurrentPage > 0) {
                        const prevBtn = document.createElement('button');
                        prevBtn.type = 'button';
                        prevBtn.className = 'btn btn-secondary';
                        prevBtn.textContent = /*[[#{memory.block.gallery.pagination.previous}]]*/ 'Previous';
                        prevBtn.onclick = () => loadImmichPage(pageCurrentPage - 1);
                        paginationDiv.appendChild(prevBtn);
                    }
                    
                    const pageInfo = document.createElement('span');
                    pageInfo.className = 'page-info';
                    pageInfo.textContent = `${pageCurrentPage + 1} / ${pageTotalPages}`;
                    paginationDiv.appendChild(pageInfo);
                    
                    if (pageCurrentPage < pageTotalPages - 1) {
                        const nextBtn = document.createElement('button');
                        nextBtn.type = 'button';
                        nextBtn.className = 'btn btn-secondary';
                        nextBtn.textContent = /*[[#{memory.block.gallery.pagination.next}]]*/ 'Next';
                        nextBtn.onclick = () => loadImmichPage(pageCurrentPage + 1);
                        paginationDiv.appendChild(nextBtn);
                    }
                    
                    pagination.appendChild(paginationDiv);
                }
            }
        })();
    </script>
</div>

<!-- Memory block fragment -->
<div th:fragment="memory-block" class="memory-block" th:attr="data-block-id=${block.id}, data-block-type=${block.blockType.name()}">
    <div class="block-header">
        <span class="block-type-badge" th:text="${block.blockType.name()}">BLOCK TYPE</span>
        <div class="block-actions">
            <button class="btn-icon" th:attr="data-block-id=${block.id}"><i class="lni lni-pencil"></i></button>
                <button type="button" 
                        class="btn-icon danger" 
                        th:attr="hx-delete=@{/memories/{memoryId}/blocks/{blockId}(memoryId=${memory.id}, blockId=${block.id})}"
                        hx-target="closest .memory-block"
                        hx-swap="outerHTML"
                        hx-confirm="Delete this block?"
                        onclick="return confirm('Delete this block?')">
                    <i class="lni lni-trash"></i>
                </button>
        </div>
    </div>
    <div class="block-content">
        <div th:if="${block.blockType.name() == 'TEXT'}" class="text-block">
            <h3>Text Block</h3>
            <p>Content will be loaded here</p>
        </div>
        <div th:if="${block.blockType.name() == 'VISIT'}" class="visit-block">
            <i class="lni lni-map-marker"></i>
            <p>Visit block</p>
        </div>
        <div th:if="${block.blockType.name() == 'TRIP'}" class="trip-block">
            <i class="lni lni-direction"></i>
            <p>Trip block</p>
        </div>
        <div th:if="${block.blockType.name() == 'IMAGE_GALLERY'}" class="gallery-block">
            <i class="lni lni-gallery"></i>
            <p>Image gallery</p>
        </div>
    </div>
    
    <script>
        // Attach edit handler
        document.querySelectorAll('.btn-icon[data-block-id]').forEach(btn => {
            btn.addEventListener('click', function() {
                const blockId = this.getAttribute('data-block-id');
                editBlock(blockId);
            });
        });
        
        function editBlock(blockId) {
            // Implement edit functionality
            console.log('Edit block:', blockId);
        }
    </script>
</div>

</body>
</html>
