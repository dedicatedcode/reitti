<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
</head>
<body>

<!-- Block type selection fragment -->
<div th:fragment="block-type-selection" class="block-type-selection">
    <h3 th:text="#{memory.block.select.type}">Select Block Type</h3>
    <div class="block-type-grid">
        <button type="button" 
                class="block-type-option"
                th:attr="hx-get=@{/memories/{id}/blocks/new(id=${memoryId}, type='TEXT', position=${position})}"
                hx-target=".block-type-selection"
                hx-swap="outerHTML">
            <span th:text="#{memory.block.type.text}">Text Block</span>
            <p th:text="#{memory.block.type.text.description}">Add text content with headlines and paragraphs</p>
        </button>
        
        <button type="button" 
                class="block-type-option"
                th:attr="hx-get=@{/memories/{id}/blocks/new(id=${memoryId}, type='VISIT', position=${position})}"
                hx-target=".block-type-selection"
                hx-swap="outerHTML">
            <span th:text="#{memory.block.type.visit}">Visit Block</span>
            <p th:text="#{memory.block.type.visit.description}">Add a location you visited during this memory</p>
        </button>
        
        <button type="button" 
                class="block-type-option"
                th:attr="hx-get=@{/memories/{id}/blocks/new(id=${memoryId}, type='TRIP_CLUSTER', position=${position})}"
                hx-target=".block-type-selection"
                hx-swap="outerHTML">
            <span th:text="#{memory.block.type.trip}">Trip Block</span>
            <p th:text="#{memory.block.type.trip.description}">Add a journey or route from this memory</p>
        </button>
        
        <button type="button" 
                class="block-type-option"
                th:attr="hx-get=@{/memories/{id}/blocks/new(id=${memoryId}, type='IMAGE_GALLERY', position=${position})}"
                hx-target=".block-type-selection"
                hx-swap="outerHTML">
            <span th:text="#{memory.block.type.gallery}">Image Gallery</span>
            <p th:text="#{memory.block.type.gallery.description}">Add a collection of photos from this memory</p>
        </button>
    </div>
    
    <div class="form-actions">
        <button type="button" 
                class="btn btn-secondary"
                hx-get="/memories/fragments/empty"
                hx-target=".block-type-selection"
                hx-swap="delete"
                th:text="#{memory.block.cancel}">Cancel</button>
    </div>
</div>

<!-- Empty fragment for clearing content -->
<div th:fragment="empty"></div>

<!-- Text block form -->
<div th:fragment="text-block-form" class="block-form">
    <h3 th:text="#{memory.block.text.new}">Add Text Block</h3>
    <form th:attr="hx-post=@{/memories/{id}/blocks/text(id=${memoryId}, position=${position})}" method="post" hx-target=".block-form" hx-swap="outerHTML" hx-vals="js:{timezone: getUserTimezone()}">
        
        <div class="form-group">
            <label for="headline" th:text="#{memory.block.text.headline}">Headline</label>
            <input type="text" id="headline" name="headline" class="form-control" th:placeholder="#{memory.block.text.headline.placeholder}">
        </div>
        
        <div class="form-group">
            <label for="content" th:text="#{memory.block.text.content}">Content</label>
            <textarea id="content" name="content" class="form-control" rows="6" th:placeholder="#{memory.block.text.content.placeholder}"></textarea>
        </div>
        
        <div class="form-actions">
            <button type="button" 
                    class="btn btn-secondary"
                    hx-get="/memories/fragments/empty"
                    hx-target=".block-form"
                    hx-swap="delete"
                    th:text="#{memory.block.cancel}">Cancel</button>
            <button type="submit" class="btn btn-primary" th:text="#{memory.block.create}">Save Block</button>
        </div>
    </form>
</div>

<!-- Visit block form -->
<div th:fragment="visit-block-form" class="block-form">
    <h2 th:text="#{memory.block.visit.new}">Add Visit Block</h2>
    <form th:attr="hx-post=@{/memories/{id}/blocks/visit(id=${memoryId}, position=${position})}" method="post" hx-target=".block-form" hx-swap="outerHTML" hx-vals="js:{timezone: getUserTimezone()}">
        
        <div class="form-group">
            <label for="visitId" th:text="#{memory.block.visit.select}">Select Visit</label>
            <select id="visitId" name="visitId" class="form-control" required>
                <option value="" th:text="#{memory.block.visit.select.placeholder}">Choose a visit...</option>
            </select>
        </div>
        
        <div class="form-actions">
            <button type="button"
                    class="btn btn-secondary"
                    hx-get="/memories/fragments/empty"
                    hx-target=".block-form"
                    hx-swap="delete"
                    th:text="#{memory.block.cancel}">Cancel</button>
            <button type="submit" class="btn btn-primary" th:text="#{memory.block.create}">Save Block</button>
        </div>
    </form>
</div>

<!-- Trip block form -->
<div th:fragment="trip-block-form" class="block-form">
    <h2 th:text="#{memory.block.trip.new}">Edit Trips Block</h2>
    <form th:attr="hx-post=@{/memories/{id}/blocks/trip-cluster(id=${memoryId}, position=${position})}" method="post" hx-target=".block-form" hx-swap="outerHTML" hx-vals="js:{timezone: getUserTimezone()}">
        <div class="form-group">
            <label th:text="#{memory.edit.block.title}" for="title">Title</label>
            <input type="text" id="title" name="title" class="form-control" th:placeholder="#{memory.edit.block.title.placeholder}" placeholder="Enter title">
        </div>
        <div class="form-group">
            <label th:text="#{memory.edit.block.cluster.trip.select.trips}">Select Trips</label>
            <table class="table">
                <thead>
                <tr>
                    <th th:text="#{memory.edit.block.cluster.trip.selected}">Selected</th>
                    <th th:text="#{memory.edit.block.cluster.trip.trip}">Trip</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="trip : ${availableTrips}">
                    <td>
                        <input type="checkbox"
                               name="selectedTrips"
                               th:value="${trip.id}">
                    </td>
                    <td th:text="${#temporals.format(trip.startTime, 'MMM d, yyyy HH:mm')} + ' (' + ${trip.startVisit != null and trip.startVisit.place != null ? trip.startVisit.place.name : 'Unknown'} + ') -> ' + ${#temporals.format(trip.endTime, 'HH:mm')} + ' (' + ${trip.endVisit != null and trip.endVisit.place != null ? trip.endVisit.place.name : 'Unknown'} + ')'">Trip details</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="form-actions">
            <button type="button"
                    class="btn btn-secondary"
                    hx-get="/memories/fragments/empty"
                    hx-target=".block-form"
                    hx-swap="delete"
                    th:text="#{memory.block.cancel}">Cancel</button>
            <button type="submit" class="btn btn-primary" th:text="#{memory.block.create}">Save Block</button>
        </div>
    </form>
</div>

<!-- Image gallery block form -->
<div th:fragment="image-gallery-block-form" class="block-form gallery-block-form">
    <h3 th:text="#{memory.block.gallery.new}">New Image Gallery Block</h3>
    
    <form th:attr="hx-post=@{/memories/{id}/blocks/image-gallery(id=${memoryId}, position=${position})}" method="post" hx-target=".block-form" hx-swap="outerHTML" hx-vals="js:{timezone: getUserTimezone()}">
        <div class="gallery-panels">
            <!-- Immich Panel -->
            <div class="gallery-panel immich-panel" th:if="${immichEnabled}">
                <h4 th:text="#{memory.block.gallery.immich.title}">Select from Immich</h4>
                <div class="immich-photos-container">
                    <div class="immich-photos-grid" 
                         id="immichPhotosGrid"
                         th:attr="hx-get=@{/memories/{id}/blocks/immich-photos(id=${memoryId},page=0)}"
                         hx-trigger="load"
                         hx-swap="outerHTML">
                        <div class="loading" th:text="#{memory.block.gallery.loading}">Loading photos...</div>
                    </div>
                    <div class="immich-pagination" id="immichPagination"></div>
                </div>
            </div>

            <!-- File Upload Panel -->
            <div class="gallery-panel upload-panel">
                <h4 th:text="#{memory.block.gallery.upload.title}">Upload Images</h4>
                <div class="upload-area">
                    <input type="file" 
                           id="fileInput" 
                           name="files" 
                           multiple 
                           accept="image/*" 
                           class="form-control"
                           th:attr="hx-post=@{/memories/{id}/blocks/upload-image(id=${memoryId})}"
                           hx-target="#selectedPhotos"
                           hx-swap="beforeend">
                    <label for="fileInput" class="upload-label">
                        <i class="lni lni-cloud-upload"></i>
                        <span th:text="#{memory.block.gallery.upload.choose}">Choose files or drag here</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Combined Selected Photos Section -->
        <div class="selected-photos-section">
            <h4 th:text="#{memory.block.gallery.selected.title}">Selected Photos</h4>
            <div class="selected-photos-combined" id="selectedPhotos"></div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" th:text="#{memory.block.create}">Create Gallery Block</button>
            <button type="button"
                    class="btn btn-secondary"
                    th:attr="hx-get=@{/memories/fragments/empty}"
                    hx-target=".block-form"
                    hx-swap="delete"
                    th:text="#{memory.block.cancel}">Cancel</button>
        </div>
    </form>

    <script th:inline="javascript">
        class GalleryBlockManager {
            constructor(memoryId, position) {
                this.memoryId = memoryId;
                this.position = position;
                this.selectedImmichPhotos = new Map();
                this.currentPage = 0;
                this.totalPages = 0;
            }

            toggleImmichPhoto(assetId, thumbnailUrl) {
                const form = document.querySelector('.gallery-block-form form');
                if (this.selectedImmichPhotos.has(assetId)) {
                    this.selectedImmichPhotos.delete(assetId);
                    
                    const photoItem = document.querySelector(`[data-asset-id="${assetId}"]`);
                    if (photoItem) {
                        photoItem.classList.remove('selected');
                    }
                    
                    // Remove hidden input
                    const hiddenInput = form.querySelector(`input[name="immichImages"][value="${assetId}:${thumbnailUrl}"]`);
                    if (hiddenInput) {
                        hiddenInput.remove();
                    }
                } else {
                    this.selectedImmichPhotos.set(assetId, thumbnailUrl);
                    
                    const photoItem = document.querySelector(`[data-asset-id="${assetId}"]`);
                    if (photoItem) {
                        photoItem.classList.add('selected');
                    }
                    
                    // Add hidden input
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'immichImages';
                    hiddenInput.value = `${assetId}:${thumbnailUrl}`;
                    form.appendChild(hiddenInput);
                }
            }

            loadImmichPage(page) {
                this.currentPage = page;
                htmx.ajax('GET', `/memories/${this.memoryId}/blocks/immich-photos?page=${page}`, {
                    target: '.immich-photos-grid',
                    swap: 'outerHTML'
                });
            }
        }

        const galleryManager = new GalleryBlockManager(/*[[${memoryId}]]*/ 0,/*[[${position}]]*/ 0,);

        function toggleImmichPhoto(assetId, thumbnailUrl) {
            galleryManager.toggleImmichPhoto(assetId, thumbnailUrl);
        }

        function loadImmichPage(page) {
            galleryManager.loadImmichPage(page);
        }

    </script>
</div>

<!-- Selected photo item fragment -->
<div th:fragment="selected-photo-item" class="selected-photo-item">
    <img th:src="${url}" alt="Uploaded image">
    <input type="hidden" name="uploadedUrls" th:value="${url}">
    <button type="button" 
            hx-get="/memories/fragments/empty" 
            hx-target="closest .selected-photo-item" 
            hx-swap="delete"
            th:text="#{memory.block.gallery.remove}">Remove</button>
</div>

<!-- Immich photos grid fragment -->
<div class="immich-photos-grid" th:fragment="immich-photos-grid">
    <div th:if="${photos.isEmpty()}" class="no-photos" th:text="#{memory.block.gallery.immich.no.photos}">
        No photos found for this date range
    </div>
    <div th:each="photo : ${photos}" 
         class="immich-photo-item"
         th:attr="data-asset-id=${photo.id},data-thumbnail-url=${photo.thumbnailUrl}">
        <img th:src="${photo.thumbnailUrl}" th:alt="${photo.fileName}">
        <div class="photo-overlay">
            <i class="lni lni-check-circle-1"></i>
        </div>
    </div>
    
    <script th:inline="javascript">
        (function() {
            const pageTotalPages = /*[[${totalPages}]]*/ 0;
            const pageCurrentPage = /*[[${currentPage}]]*/ 0;
            
            if (typeof galleryManager !== 'undefined') {
                galleryManager.totalPages = pageTotalPages;
                galleryManager.currentPage = pageCurrentPage;
            }
            
            document.querySelectorAll('.immich-photo-item').forEach(item => {
                const assetId = item.getAttribute('data-asset-id');
                const thumbnailUrl = item.getAttribute('data-thumbnail-url');
                
                if (typeof galleryManager !== 'undefined' && galleryManager.selectedImmichPhotos.has(assetId)) {
                    item.classList.add('selected');
                }
                
                item.addEventListener('click', function() {
                    if (typeof galleryManager !== 'undefined') {
                        galleryManager.toggleImmichPhoto(assetId, thumbnailUrl);
                    }
                });
            });
            
            const pagination = document.getElementById('immichPagination');
            if (pagination) {
                pagination.innerHTML = '';
                
                if (pageTotalPages > 1) {
                    const paginationDiv = document.createElement('div');
                    paginationDiv.className = 'pagination-controls';
                    
                    if (pageCurrentPage > 0) {
                        const prevBtn = document.createElement('button');
                        prevBtn.type = 'button';
                        prevBtn.className = 'btn btn-secondary';
                        prevBtn.textContent = /*[[#{memory.block.gallery.pagination.previous}]]*/ 'Previous';
                        prevBtn.onclick = () => {
                            if (typeof galleryManager !== 'undefined') {
                                galleryManager.loadImmichPage(pageCurrentPage - 1);
                            }
                        };
                        paginationDiv.appendChild(prevBtn);
                    }
                    
                    const pageInfo = document.createElement('span');
                    pageInfo.className = 'page-info';
                    pageInfo.textContent = `${pageCurrentPage + 1} / ${pageTotalPages}`;
                    paginationDiv.appendChild(pageInfo);
                    
                    if (pageCurrentPage < pageTotalPages - 1) {
                        const nextBtn = document.createElement('button');
                        nextBtn.type = 'button';
                        nextBtn.className = 'btn btn-secondary';
                        nextBtn.textContent = /*[[#{memory.block.gallery.pagination.next}]]*/ 'Next';
                        nextBtn.onclick = () => {
                            if (typeof galleryManager !== 'undefined') {
                                galleryManager.loadImmichPage(pageCurrentPage + 1);
                            }
                        };
                        paginationDiv.appendChild(nextBtn);
                    }
                    
                    pagination.appendChild(paginationDiv);
                }
            }
        })();
    </script>
</div>

</body>
</html>
