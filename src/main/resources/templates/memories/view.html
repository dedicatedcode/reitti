<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${memory.title} + ' - Reitti'">Memory - Reitti</title>
    <link rel="icon" th:href="@{/img/logo.svg}">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/memories.css">
    <link rel="stylesheet" href="/css/lineicons.css">
    <link rel="stylesheet" href="/css/leaflet.css">
    <script src="/js/htmx.min.js"></script>
    <script src="/js/leaflet.js"></script>
    <script src="/js/leaflet.geodesic.2.7.2.js"></script>
</head>
<body class="memories-page">
<div class="settings-container">
    <div class="settings-content-area">
        <div class="memory-header" th:fragment="memory-header">
            <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                <button type="button" 
                        class="btn btn-secondary"
                        th:attr="hx-get=@{/memories/{id}/edit(id=${memory.id})}"
                        hx-target=".memory-header"
                        hx-swap="innerHTML">
                    <i class="lni lni-pencil"></i> Edit
                </button>
            </div>
            
            <div class="memory-header-section" th:if="${memory.headerType.name() == 'IMAGE' && memory.headerImageUrl != null}">
                <img th:src="${memory.headerImageUrl}" th:alt="${memory.title}" class="memory-header-image-large">
            </div>

            <div class="memory-header-section map-header-section" th:if="${memory.headerType.name() == 'MAP'}">
                <div id="memory-map" class="memory-map"></div>
            </div>

            <div class="memory-details">
                <h1 class="memory-date-range-large">
                    <span th:text="${memory.title}">Title</span>
                </h1>
                <p class="memory-description-large" th:if="${memory.description != null && !memory.description.isEmpty()}"
                   th:text="${memory.description}">Description</p>
            </div>
            <div class="memory-details">
                <p class="memory-date-range-large">
                    <i class="lni lni-calendar"></i>
                    <span th:text="${#temporals.format(memory.startDate, 'MMMM d, yyyy')}">Start Date</span>
                    <span th:if="${memory.startDate != memory.endDate}">
                        - <span th:text="${#temporals.format(memory.endDate, 'MMMM d, yyyy')}">End Date</span>
                    </span>
                </p>
                <p class="memory-description-large" th:if="${memory.description != null && !memory.description.isEmpty()}"
                   th:text="${memory.description}">Description</p>
            </div>
        </div>

        <div class="memory-blocks-container">
            <div class="blocks-header">
                <h2>Blocks</h2>
                <button class="btn btn-primary" onclick="showAddBlockModal()"><i class="lni lni-plus"></i> Add Block</button>
            </div>

            <div th:if="${blocks.isEmpty()}" class="empty-blocks">
                <i class="lni lni-layers"></i>
                <p>No blocks yet. Add your first block to start building your memory.</p>
            </div>

            <div class="blocks-list" id="blocksList">
                <div th:each="block : ${blocks}" class="memory-block" th:attr="data-block-id=${block.id}, data-block-type=${block.blockType.name()}">
                    <div class="block-header">
                        <span class="block-type-badge" th:text="${block.blockType.name()}">BLOCK TYPE</span>
                        <div class="block-actions">
                            <button class="btn-icon" th:onclick="'editBlock(' + ${block.id} + ')'"><i class="lni lni-pencil"></i></button>
                            <form th:action="@{/memories/{memoryId}/blocks/{blockId}(memoryId=${memory.id}, blockId=${block.id})}" 
                                  method="post" style="display: inline;">
                                <input type="hidden" name="_method" value="DELETE">
                                <button type="submit" class="btn-icon danger" onclick="return confirm('Delete this block?')">
                                    <i class="lni lni-trash"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="block-content">
                        <div th:if="${block.blockType.name() == 'TEXT'}" class="text-block">
                            <h3>Text Block</h3>
                            <p>Content will be loaded here</p>
                        </div>
                        <div th:if="${block.blockType.name() == 'VISIT'}" class="visit-block">
                            <i class="lni lni-map-marker"></i>
                            <p>Visit block</p>
                        </div>
                        <div th:if="${block.blockType.name() == 'TRIP'}" class="trip-block">
                            <i class="lni lni-direction"></i>
                            <p>Trip block</p>
                        </div>
                        <div th:if="${block.blockType.name() == 'IMAGE_GALLERY'}" class="gallery-block">
                            <i class="lni lni-gallery"></i>
                            <p>Image gallery</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="addBlockModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Block</h2>
            <button class="modal-close" onclick="closeAddBlockModal()">&times;</button>
        </div>
        <form th:action="@{/memories/{id}/blocks(id=${memory.id})}" method="post">
            <div class="modal-body">
                <div class="form-group">
                    <label>Block Type</label>
                    <select name="blockType" class="form-control" required>
                        <option value="TEXT">Text</option>
                        <option value="VISIT">Visit</option>
                        <option value="TRIP">Trip</option>
                        <option value="IMAGE_GALLERY">Image Gallery</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddBlockModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Block</button>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    const memory = /*[[${memory}]]*/ {};
    
    // Initialize map if header type is MAP
    if (memory.headerType === 'MAP') {
        const map = L.map('memory-map', {
            zoomControl: true,
            attributionControl: false
        }).setView([51.505, -0.09], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // TODO: Load and display path data for the memory date range
    }

    function showAddBlockModal() {
        document.getElementById('addBlockModal').style.display = 'flex';
    }

    function closeAddBlockModal() {
        document.getElementById('addBlockModal').style.display = 'none';
    }

    function editBlock(blockId) {
        window.location.href = '/memories/' + memory.id + '/blocks/' + blockId + '/edit';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('addBlockModal');
        if (event.target === modal) {
            closeAddBlockModal();
        }
    }
</script>
</body>
</html>
