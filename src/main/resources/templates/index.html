<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reitti - Your Location Timeline</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel= "stylesheet" href= "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" >
    <link rel= "stylesheet" href= "/css/main.css" >
    <link rel= "stylesheet" href= "/css/date-picker.css" >
    <script src="/js/HumanizeDuration.js"></script>
    <script src="/js/horizontal-date-picker.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,100..900;1,9..144,100..900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
        }
        
        /* Settings Overlay Styles */
        .settings-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        
        .settings-content {
            background-color: #f5f5f5;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 1200px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .close-settings {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -10px;
        }
        
        .close-settings:hover,
        .close-settings:focus {
            color: black;
            text-decoration: none;
        }
        
        .settings-nav {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .settings-nav-item {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .settings-nav-item.active {
            border-bottom: 3px solid #4a89dc;
            font-weight: bold;
        }

        .settings-section {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .settings-section.active {
            display: block;
        }
        
        .alert {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f5f5f5;
        }

        tr:hover {
            background-color: #f9f9f9;
        }
        
        .queue-status {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .queue-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 200px;
        }

        .queue-name {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .queue-count {
            font-size: 24px;
            color: #4a89dc;
        }

        .queue-time {
            margin-top: 10px;
            color: #666;
        }

        .progress-bar {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #4a89dc;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* Places Management Styles */
        .places-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .place-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .place-map {
            height: 150px;
            background-color: #f0f0f0;
        }

        .place-details {
            padding: 15px;
        }

        .place-info {
            margin: 15px 0;
            font-size: 0.9em;
            color: #555;
        }

        .place-info div {
            margin-bottom: 5px;
        }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
        }

        header {
            position: absolute;
            top: 0;
            left: 40%;
            z-index: 10;
            background: rgba(59, 59, 59, 0.62);
            backdrop-filter: blur(10px);
            color: white;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        nav {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }


        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }


        .timeline::-webkit-scrollbar {
            display: none;
        }

        .timeline {
            position: absolute;
            top: 0;
            width: 50%;
            bottom: 0;
            background: #3b3b3b;
            background: linear-gradient(90deg, rgb(17, 17, 17) 0%, rgba(59, 59, 59, 0.49) 76%, rgba(255, 255, 255, 0) 100%);
            z-index: 5;
            overflow-y: auto;
            pointer-events: none;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */

        }

        .timeline-container {
            pointer-events: all;
            width: 350px;
            font-family: "Serif";
            padding-bottom: 250px;
        }
        .timeline-entry {
            color: #bfbfbf;
            padding: 1rem 2rem;
            transition: color, padding 0.5s ease-in-out;
            font-weight: lighter;
        }
        .timeline-entry.active {
            color: #f8f8f8;
            padding: 1rem 2.5rem;
            transition: color, padding 0.5s ease-in-out;
        }

        .timeline-entry .entry-description {
            font-family: "Fraunces";
            font-size: 3rem;
            transition: font-size 0.5s ease-in-out;
        }

        .timeline-entry .entry-icon {
            padding: 8px;
        }

        .timeline-entry .entry-time {
            padding: 0 32px;
        }

        .timeline-entry.active .entry-description {
            font-family: "Fraunces";
            font-size: 5rem;
            transition: font-size 0.5s ease-in-out;
        }

        .htmx-request .htmx-indicator {
            display: inline;
        }

        button {
            background-color: transparent;
            color: wheat;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #959595;
        }

        .timeline-header {
            display: inline-flex;
            align-items: baseline;
            padding: 8px;
            border-bottom: 1px black;
            margin-left: 2rem;
            pointer-events: auto;
        }

        .timeline-header {
            position: sticky;
            font-size: 1.4rem;
        }

        .date-item.selected {
            background-color: unset;
            color: wheat;
            transform: scale(1.05);
            box-shadow: unset;
        }

        .month-item.selected {
            background-color: #4a89dc;
            color: wheat;
            font-weight: bolder;
            background: unset;
        }

        .year-item.selected {
            background-color: #4a89dc;
            color: wheat;
            font-weight: bolder;
            background: unset;
        }
        .today-button {
            background-color: unset;
        }
        .date-item {
            padding: unset;
            margin: unset;
            border-radius: 0;
        }
        .date-item:hover {
            background-color: unset;
            border-bottom: 1px solid white;
        }

        .date-item.selected:hover {
            border-bottom: 0;
        }

        .date-item .day-name,
        .date-item .day-number {
            font-size: 2rem;
            font-weight: lighter;
        }
        .horizontal-date-picker {
            position: fixed;
            font-family: "Fraunces";
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(59, 59, 59, 0.68);
            backdrop-filter: blur(10px);
            padding: 10px 0;
            z-index: 50;
            box-shadow: unset;
        }
    </style>
</head>
<body>
<div id="map"></div>

<!-- Settings Overlay -->
<div id="settings-overlay" class="settings-overlay">
    <div class="settings-content">
        <span class="close-settings">&times;</span>
        
        <div class="settings-nav">
            <div class="settings-nav-item active" data-target="api-tokens">API Tokens</div>
            <div class="settings-nav-item" data-target="user-management">User Management</div>
            <div class="settings-nav-item" data-target="places-management">Places</div>
            <div class="settings-nav-item" data-target="job-status">Job Status</div>
        </div>

        <!-- API Tokens Section -->
        <div id="api-tokens" class="settings-section active">
            <h2>API Tokens</h2>

            <div id="token-message" class="alert" style="display: none;"></div>

            <form id="token-form" action="/settings/tokens" method="post" style="margin-bottom: 20px;">
                <div class="form-group">
                    <label for="tokenName">Token Name</label>
                    <input type="text" id="tokenName" name="name" required placeholder="Enter a name for this token">
                </div>
                <button type="submit" class="btn">Create New Token</button>
            </form>

            <div id="tokens-container">
                <!-- Tokens will be loaded here -->
            </div>
        </div>

        <!-- User Management Section -->
        <div id="user-management" class="settings-section">
            <h2>User Management</h2>

            <div id="user-message" class="alert" style="display: none;"></div>

            <h3>Existing Users</h3>
            <div id="users-container">
                <!-- Users will be loaded here -->
            </div>

            <form id="user-form" action="/settings/users" method="post" style="margin-top: 30px;">
                <h3>Add New User</h3>
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="displayName">Display Name</label>
                    <input type="text" id="displayName" name="displayName" required placeholder="Enter display name">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required placeholder="Enter password">
                </div>
                <button type="submit" class="btn">Create User</button>
            </form>
        </div>

        <!-- Places Management Section -->
        <div id="places-management" class="settings-section">
            <h2>Significant Places</h2>

            <div id="place-message" class="alert" style="display: none;"></div>

            <div class="pagination-controls">
                <span id="pagination-info">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                <div class="pagination-buttons">
                    <button id="prev-page" class="btn">Previous</button>
                    <button id="next-page" class="btn">Next</button>
                </div>
            </div>

            <div id="places-container" class="places-grid">
                <!-- Places will be loaded here -->
            </div>
        </div>

        <!-- Job Status Section -->
        <div id="job-status" class="settings-section">
            <h2>Job Status</h2>

            <div id="queue-stats-container" class="queue-status">
                <!-- Queue stats will be loaded here -->
            </div>

            <div style="margin-top: 20px;">
                <button id="refreshStatus" class="btn">Refresh Status</button>
            </div>
        </div>
    </div>
</div>


<div class="timeline">
    <span class="timeline-header">
        <a href="/" class="nav-link"><i class="fas fa-house-flag"></i></a>
        <a href="#" id="settings-button" class="nav-link"><i class="fas fa-cog"></i></a>
        <form th:action="@{/logout}" method="post" style="display: inline;">
            <button type="submit" class="nav-link" style="background: none; border: none; cursor: pointer;"><i class="fas fa-right-from-bracket"></i>
            </button>
        </form>
    </span>

    <div class="timeline-container">
        <div id="loading-indicator" style="display: none;">Loading...</div>
        <!-- Timeline entries will be loaded here -->
    </div>
</div>

<!-- Horizontal date picker will be initialized here -->
<div id="horizontal-date-picker-container"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Settings overlay functionality
        const settingsButton = document.getElementById('settings-button');
        const settingsOverlay = document.getElementById('settings-overlay');
        const closeSettings = document.querySelector('.close-settings');
        
        // Open settings overlay
        settingsButton.addEventListener('click', function(e) {
            e.preventDefault();
            settingsOverlay.style.display = 'block';
            loadSettingsData();
        });
        
        // Close settings overlay
        closeSettings.addEventListener('click', function() {
            settingsOverlay.style.display = 'none';
        });
        
        // Close when clicking outside the content
        window.addEventListener('click', function(event) {
            if (event.target === settingsOverlay) {
                settingsOverlay.style.display = 'none';
            }
        });
        
        // Tab navigation in settings
        const navItems = document.querySelectorAll('.settings-nav-item');
        const sections = document.querySelectorAll('.settings-section');
        
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                const target = this.getAttribute('data-target');

                // Update active nav item
                navItems.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');

                // Show target section
                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === target) {
                        section.classList.add('active');
                    }
                });
                
                // Load section-specific data
                if (target === 'api-tokens') {
                    loadTokens();
                } else if (target === 'user-management') {
                    loadUsers();
                } else if (target === 'places-management') {
                    loadPlaces(0);
                } else if (target === 'job-status') {
                    loadQueueStats();
                }
            });
        });
        
        // Function to load all settings data
        function loadSettingsData() {
            // Load initial data for the active tab
            const activeTab = document.querySelector('.settings-nav-item.active').getAttribute('data-target');
            if (activeTab === 'api-tokens') {
                loadTokens();
            } else if (activeTab === 'user-management') {
                loadUsers();
            } else if (activeTab === 'places-management') {
                loadPlaces(0);
            } else if (activeTab === 'job-status') {
                loadQueueStats();
            }
        }
        
        // Load API Tokens
        function loadTokens() {
            fetch('/settings/api-tokens')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('tokens-container');
                    if (data.length === 0) {
                        container.innerHTML = '<p>No API tokens found. Create one to get started.</p>';
                        return;
                    }
                    
                    let html = '<table><thead><tr><th>Name</th><th>Token</th><th>Created</th><th>Last Used</th><th>Actions</th></tr></thead><tbody>';
                    data.forEach(token => {
                        html += `<tr>
                            <td>${token.name}</td>
                            <td>${token.token}</td>
                            <td>${formatDateTime(token.createdAt)}</td>
                            <td>${token.lastUsedAt ? formatDateTime(token.lastUsedAt) : 'Never'}</td>
                            <td>
                                <button class="btn btn-danger delete-token" data-id="${token.id}">Delete</button>
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-token').forEach(button => {
                        button.addEventListener('click', function() {
                            const tokenId = this.getAttribute('data-id');
                            deleteToken(tokenId);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading tokens:', error);
                    document.getElementById('tokens-container').innerHTML = '<p>Error loading tokens. Please try again.</p>';
                });
        }
        
        // Create new token
        document.getElementById('token-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/settings/tokens', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const messageEl = document.getElementById('token-message');
                messageEl.textContent = data.message;
                messageEl.className = data.success ? 'alert alert-success' : 'alert alert-danger';
                messageEl.style.display = 'block';
                
                if (data.success) {
                    document.getElementById('tokenName').value = '';
                    loadTokens();
                }
                
                // Hide message after 5 seconds
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                console.error('Error creating token:', error);
                const messageEl = document.getElementById('token-message');
                messageEl.textContent = 'Error creating token. Please try again.';
                messageEl.className = 'alert alert-danger';
                messageEl.style.display = 'block';
            });
        });
        
        // Delete token
        function deleteToken(tokenId) {
            if (!confirm('Are you sure you want to delete this token?')) return;
            
            fetch(`/settings/tokens/${tokenId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                const messageEl = document.getElementById('token-message');
                messageEl.textContent = data.message;
                messageEl.className = data.success ? 'alert alert-success' : 'alert alert-danger';
                messageEl.style.display = 'block';
                
                if (data.success) {
                    loadTokens();
                }
                
                // Hide message after 5 seconds
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                console.error('Error deleting token:', error);
                const messageEl = document.getElementById('token-message');
                messageEl.textContent = 'Error deleting token. Please try again.';
                messageEl.className = 'alert alert-danger';
                messageEl.style.display = 'block';
            });
        }
        
        // Load Users
        function loadUsers() {
            fetch('/settings/users')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('users-container');
                    if (data.length === 0) {
                        container.innerHTML = '<p>No users found.</p>';
                        return;
                    }
                    
                    let html = '<table><thead><tr><th>Username</th><th>Display Name</th><th>Actions</th></tr></thead><tbody>';
                    data.forEach(user => {
                        html += `<tr>
                            <td>${user.username}</td>
                            <td>${user.displayName}</td>
                            <td>
                                ${user.currentUser ? 
                                    '<span>(Current User)</span>' : 
                                    `<button class="btn btn-danger delete-user" data-id="${user.id}">Delete</button>`}
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-user').forEach(button => {
                        button.addEventListener('click', function() {
                            const userId = this.getAttribute('data-id');
                            deleteUser(userId);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    document.getElementById('users-container').innerHTML = '<p>Error loading users. Please try again.</p>';
                });
        }
        
        // Create new user
        document.getElementById('user-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch('/settings/users', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const messageEl = document.getElementById('user-message');
                messageEl.textContent = data.message;
                messageEl.className = data.success ? 'alert alert-success' : 'alert alert-danger';
                messageEl.style.display = 'block';
                
                if (data.success) {
                    document.getElementById('username').value = '';
                    document.getElementById('displayName').value = '';
                    document.getElementById('password').value = '';
                    loadUsers();
                }
                
                // Hide message after 5 seconds
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                console.error('Error creating user:', error);
                const messageEl = document.getElementById('user-message');
                messageEl.textContent = 'Error creating user. Please try again.';
                messageEl.className = 'alert alert-danger';
                messageEl.style.display = 'block';
            });
        });
        
        // Delete user
        function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This will delete all their data.')) return;
            
            fetch(`/settings/users/${userId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                const messageEl = document.getElementById('user-message');
                messageEl.textContent = data.message;
                messageEl.className = data.success ? 'alert alert-success' : 'alert alert-danger';
                messageEl.style.display = 'block';
                
                if (data.success) {
                    loadUsers();
                }
                
                // Hide message after 5 seconds
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                const messageEl = document.getElementById('user-message');
                messageEl.textContent = 'Error deleting user. Please try again.';
                messageEl.className = 'alert alert-danger';
                messageEl.style.display = 'block';
            });
        }
        
        // Load Places with pagination
        let currentPage = 0;
        let totalPages = 1;
        
        function loadPlaces(page) {
            fetch(`/settings/places?page=${page}`)
                .then(response => response.json())
                .then(data => {
                    currentPage = data.number;
                    totalPages = data.totalPages;
                    
                    // Update pagination info
                    document.getElementById('current-page').textContent = currentPage + 1;
                    document.getElementById('total-pages').textContent = totalPages;
                    
                    // Enable/disable pagination buttons
                    document.getElementById('prev-page').disabled = currentPage === 0;
                    document.getElementById('next-page').disabled = currentPage >= totalPages - 1;
                    
                    const container = document.getElementById('places-container');
                    if (data.content.length === 0) {
                        container.innerHTML = '<p>No significant places found.</p>';
                        return;
                    }
                    
                    let html = '';
                    data.content.forEach(place => {
                        html += `
                        <div class="place-card">
                            <div class="place-map" id="map-${place.id}"></div>
                            <div class="place-details">
                                <form class="place-form" data-id="${place.id}">
                                    <div class="form-group">
                                        <label for="name-${place.id}">Name</label>
                                        <input type="text" id="name-${place.id}" name="name" value="${place.name}" required>
                                    </div>
                                    <div class="place-info">
                                        <div><strong>Address:</strong> <span>${place.address || 'Not available'}</span></div>
                                        <div><strong>Category:</strong> <span>${place.category || 'Not categorized'}</span></div>
                                        <div><strong>Coordinates:</strong> <span>${place.latitudeCentroid}, ${place.longitudeCentroid}</span></div>
                                    </div>
                                    <button type="submit" class="btn">Update</button>
                                </form>
                            </div>
                        </div>`;
                    });
                    container.innerHTML = html;
                    
                    // Initialize maps for places
                    data.content.forEach(place => {
                        initPlaceMap(place.id, place.latitudeCentroid, place.longitudeCentroid);
                    });
                    
                    // Add event listeners to place forms
                    document.querySelectorAll('.place-form').forEach(form => {
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            const placeId = this.getAttribute('data-id');
                            const name = document.getElementById(`name-${placeId}`).value;
                            updatePlace(placeId, name);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error loading places:', error);
                    document.getElementById('places-container').innerHTML = '<p>Error loading places. Please try again.</p>';
                });
        }
        
        // Initialize map for a place
        function initPlaceMap(placeId, lat, lng) {
            const mapContainer = document.getElementById(`map-${placeId}`);
            if (!mapContainer) return;
            
            // Initialize map
            const placeMap = L.map(`map-${placeId}`).setView([lat, lng], 15);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(placeMap);
            
            // Add marker
            L.marker([lat, lng]).addTo(placeMap);
            
            // Add circle to show approximate area
            L.circle([lat, lng], {
                color: '#4a89dc',
                fillColor: '#4a89dc',
                fillOpacity: 0.2,
                radius: 50 // 50 meters radius
            }).addTo(placeMap);
        }
        
        // Update place
        function updatePlace(placeId, name) {
            const formData = new FormData();
            formData.append('name', name);
            
            fetch(`/settings/places/${placeId}/update`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const messageEl = document.getElementById('place-message');
                messageEl.textContent = data.message;
                messageEl.className = data.success ? 'alert alert-success' : 'alert alert-danger';
                messageEl.style.display = 'block';
                
                // Hide message after 5 seconds
                setTimeout(() => {
                    messageEl.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                console.error('Error updating place:', error);
                const messageEl = document.getElementById('place-message');
                messageEl.textContent = 'Error updating place. Please try again.';
                messageEl.className = 'alert alert-danger';
                messageEl.style.display = 'block';
            });
        }
        
        // Pagination controls
        document.getElementById('prev-page').addEventListener('click', function() {
            if (currentPage > 0) {
                loadPlaces(currentPage - 1);
            }
        });
        
        document.getElementById('next-page').addEventListener('click', function() {
            if (currentPage < totalPages - 1) {
                loadPlaces(currentPage + 1);
            }
        });
        
        // Load Queue Stats
        function loadQueueStats() {
            fetch('/api/v1/queue-stats')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('queue-stats-container');
                    let html = '';
                    
                    data.forEach(queue => {
                        html += `
                        <div class="queue-card">
                            <div class="queue-name">${queue.name}</div>
                            <div class="queue-count">${queue.count}</div>
                            <div class="queue-time">Est. processing time: ${queue.estimatedTime}</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width:${queue.rate}%"></div>
                            </div>
                        </div>`;
                    });
                    
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading queue stats:', error);
                    document.getElementById('queue-stats-container').innerHTML = '<p>Error loading queue statistics. Please try again.</p>';
                });
        }
        
        // Refresh queue stats
        document.getElementById('refreshStatus').addEventListener('click', loadQueueStats);
        
        // Helper function to format date time
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString();
        }
        // Check if date is in URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        let initialDate;

        if (urlParams.has('date')) {
            initialDate = urlParams.get('date');
            // Validate date format (YYYY-MM-DD)
            if (!/^\d{4}-\d{2}-\d{2}$/.test(initialDate)) {
                initialDate = null;
            }
        }

        // Set date picker to URL date or today's date
        const today = new Date();
        const formattedDate = initialDate || today.toISOString().split('T')[0]; // YYYY-MM-DD format

        // Function to update URL with date parameter
        function updateUrlWithDate(date) {
            const url = new URL(window.location);
            url.searchParams.set('date', date);
            window.history.pushState({}, '', url);
        }

        // Initialize the map
        const map = L.map('map').setView([60.1699, 24.9384], 12); // Helsinki coordinates as default

        L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            attribution: '&copy; <a href="https://stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>',
        }).addTo(map);

        // Add scale control
        L.control.scale({
            imperial: false,
            metric: true
        }).addTo(map);

        // Function to load timeline data
        function loadTimelineData(date) {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'block';

            fetch(`/api/timeline?selectedDate=${date}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    updateTimeline(data);
                    loadingIndicator.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error fetching timeline data:', error);
                    loadingIndicator.style.display = 'none';
                });
        }

        const selectedPath = L.polyline([], {
            color: '#ff984f',
            weight: 6,
            opacity: 1,
            lineJoin: 'round',
            lineCap: 'round'
        })

        // Function to update the timeline with fetched data
        function updateTimeline(data) {
            const timelineContainer = document.querySelector('.timeline-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            timelineContainer.innerHTML = '';
            timelineContainer.appendChild(loadingIndicator);

            // Clear existing markers and paths
            map.eachLayer(layer => {
                if (!layer._url) {
                    map.removeLayer(layer);
                }
            });

            if (!data || !data.entries || data.entries.length === 0) {
                const noDataMsg = document.createElement('div');
                noDataMsg.className = 'timeline-entry';
                noDataMsg.textContent = 'No timeline data available for this date.';
                timelineContainer.appendChild(noDataMsg);
                return;
            }

            const bounds = L.latLngBounds();

            let hasValidCoords = false;

            // Create timeline entries
            data.entries.forEach(entry => {
                const entryElement = document.createElement('div');
                entryElement.className = `timeline-entry ${entry.type.toLowerCase()}`;
                entryElement.dataset.id = entry.id;

                // Set coordinates based on entry type
                if (entry.type === 'VISIT' && entry.place) {
                    entryElement.dataset.lat = entry.place.latitude;
                    entryElement.dataset.lng = entry.place.longitude;
                } else if (entry.type === 'TRIP') {
                    // For trips, use start place coordinates
                    if (entry.startPlace) {
                        entryElement.dataset.lat = entry.startPlace.latitude;
                        entryElement.dataset.lng = entry.startPlace.longitude;
                    }

                    // If trip has path data, add it
                    if (entry.path) {
                        entryElement.dataset.path = JSON.stringify(entry.path);
                    }
                }

                // Create icon element
                const iconElement = document.createElement('span');
                iconElement.className = 'entry-icon';
                iconElement.innerHTML = entry.type === 'VISIT' ? '<i class="fas fa-map-marker-alt"></i>' : '<i class="fas fa-route"></i>';

                // Create time element
                const timeElement = document.createElement('div');
                timeElement.className = 'entry-time';
                const startTime = new Date(entry.startTime);
                const endTime = new Date(entry.endTime);
                timeElement.textContent = `${startTime.toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                })} - ${endTime.toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                })}`;

                // Calculate duration
                const durationMs = endTime - startTime;
                const durationText = humanizeDuration(durationMs, {units: ["h", "m"], round: true });

                const durationElement = document.createElement('span');
                durationElement.className = 'entry-duration';
                durationElement.textContent = `Duration: ${durationText}`;

                // Create description element
                const descElement = document.createElement('div');
                descElement.className = 'entry-description';

                // Create details element
                const detailsElement = document.createElement('div');
                detailsElement.className = 'entry-details';

                if (entry.type === 'VISIT') {
                    const placeName = entry.place ? entry.place.name || 'Unknown Place' : 'Unknown Place';
                    descElement.textContent = placeName;

                    if (entry.place && entry.place.address) {
                        detailsElement.textContent = entry.place.address;
                    }

                    if (entry.place && entry.place.category) {
                        const categorySpan = document.createElement('span');
                        categorySpan.style.display = 'block';
                        categorySpan.style.marginTop = '5px';
                        categorySpan.style.fontStyle = 'italic';
                        categorySpan.textContent = entry.place.category;
                        detailsElement.appendChild(categorySpan);
                    }
                } else if (entry.type === 'TRIP') {
                    const startName = entry.startPlace ? entry.startPlace.name || 'Unknown' : 'Unknown';
                    const endName = entry.endPlace ? entry.endPlace.name || 'Unknown' : 'Unknown';
                    descElement.textContent = `Trip`;
                    detailsElement.innerHTML = `<strong>From:</strong> ${startName}<br><strong>To:</strong> ${endName}`;

                    // Add distance if available
                    if (entry.distanceMeters) {
                        const distanceKm = (entry.distanceMeters / 1000).toFixed(1);
                        durationElement.textContent = `Distance: ${distanceKm} km`;
                    }
                }

                // Add elements to entry
                entryElement.appendChild(descElement);
                entryElement.appendChild(iconElement);
                entryElement.appendChild(durationElement);
                entryElement.appendChild(timeElement);

                // Add entry to timeline
                timelineContainer.appendChild(entryElement);

                // Add markers for each entry with coordinates
                const lat = parseFloat(entryElement.dataset.lat);
                const lng = parseFloat(entryElement.dataset.lng);

                if (!isNaN(lat) && !isNaN(lng)) {
                    // Determine marker color based on entry type
                    const markerColor = entry.type === 'VISIT' ? '#4a89dc' : '#e67e22';

                    // Create marker with custom icon
                    const marker = L.circleMarker([lat, lng], {
                        radius: 8,
                        fillColor: markerColor,
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    L.circle([lat, lng], {
                        color: '#4a89dc',
                        fillColor: '#6098e3',
                        fillOpacity: 0.1,
                        radius: 30
                    }).addTo(map);

                    // Add popup with basic info
                    const popupContent = entry.type === 'VISIT'
                        ? `<b>${entry.place?.name || 'Unknown Place'}</b><br>${timeElement.textContent}`
                        : `<b>Trip</b><br>${timeElement.textContent}`;

                    marker.bindPopup(popupContent);

                    // Extend bounds for map fitting
                    bounds.extend([lat, lng]);
                    hasValidCoords = true;
                }

                // If entry has a path, add it to the map
                if (entryElement.dataset.path) {
                    try {
                        const pathData = JSON.parse(entryElement.dataset.path);
                        const latlngs = pathData.map(coord => [coord.latitude, coord.longitude]);

                        // Create polyline
                        L.polyline(latlngs, {
                            color: '#4f73ff',
                            weight: 2,
                            opacity: 0.8,
                            lineJoin: 'round',
                            lineCap: 'round'
                        }).addTo(map);

                        // Extend bounds with all path points
                        latlngs.forEach(latlng => {
                            bounds.extend(latlng);
                            hasValidCoords = true;
                        });
                    } catch (e) {
                        console.error("Error parsing path data:", e);
                    }
                }
            });

            // Fit map to bounds if we have valid coordinates
            if (hasValidCoords) {
                map.fitBounds(bounds, {
                    padding: [50, 50],
                    maxZoom: 16
                });
            }
        }

        // Handle clicks on timeline entries
        document.querySelector('.timeline-container').addEventListener('click', function (event) {
            document.querySelectorAll('.timeline-container .timeline-entry')
                .forEach(entry => entry.classList.remove('active'));
            const entry = event.target.closest('.timeline-entry');
            entry.classList.add('active');
            if (entry) {
                selectedPath.remove();
                const newBounds = L.latLngBounds();

                const lat = parseFloat(entry.dataset.lat);
                const lng = parseFloat(entry.dataset.lng);

                if (entry.dataset.path) {
                    const pathData = JSON.parse(entry.dataset.path);
                    const latlngs = pathData.map(coord => [coord.latitude, coord.longitude]);
                    latlngs.forEach(latlng => {
                        newBounds.extend(latlng);
                    });
                    selectedPath.setLatLngs(latlngs);

                    selectedPath.addTo(map)
                }
                newBounds.extend([lat, lng]);
                map.flyToBounds(newBounds, {
                    padding: [50, 50],
                    maxZoom: 16
                });
            }
        });

        loadTimelineData(formattedDate);
        
        // Parse the initial date properly to ensure correct date picker initialization
        let dateToUse = new Date();
        if (initialDate) {
            // Parse the date from URL parameter (YYYY-MM-DD format)
            const [year, month, day] = initialDate.split('-').map(Number);
            // Note: month is 0-indexed in JavaScript Date
            dateToUse = new Date(year, month - 1, day);
        }
        
        // Initialize horizontal date picker
        new HorizontalDatePicker({
            container: document.getElementById('horizontal-date-picker-container'),
            selectedDate: dateToUse,
            autoSelectOnScroll: true, // Enable auto-select on scroll
            showNavButtons: false, // Show navigation buttons
            daysToShow: 21, // Show more days
            showMonthRow: true, // Enable month selection row
            showYearRow: true, // Enable year selection row
            yearsToShow: 5, // Show 5 years in the year row
            allowFutureDates: false, // Disable selection of future dates
            showTodayButton: true, // Show the Today button
            // No min/max date for infinite scrolling
            onDateSelect: (date, formattedDate) => {
                // Update URL
                updateUrlWithDate(formattedDate);
                
                // Load timeline data
                loadTimelineData(formattedDate);
            }
        });
    });
</script>
</body>
</html>
