name: CI


on:
  push:
    branches:
      - 218-feature-request-end-to-end-e2e-frontend-testing-framework-2

  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'
        cache: maven

    - name: Install dependencies for acknowledgments script
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl

    - name: Generate acknowledgments data
      run: |
        chmod +x scripts/generate-acknowledgments.sh
        ./scripts/generate-acknowledgments.sh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build
      run: mvn verify -DskipTests

    - name: Create bundle
      run: mkdir staging && cp target/*.jar staging

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build docker image
      uses: docker/build-push-action@v6
      with:
        platforms: linux/amd64,linux/arm64
        context: .
        push: false
        tags: dedicatedcode/reitti:latest

    - name: Start docker-compose
      run: docker compose -f docker-compose.ci.yml up -d
      working-directory: e2e
    - name: Wait for app to be ready
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:8080; do sleep 2; done'
      working-directory: e2e

    - name: Install dependencies
      run: npm ci
      working-directory: e2e

    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      working-directory: e2e

    - name: Run Playwright tests
      run: CI=1 npx playwright test --project=chromium --project=firefox --project=webkit --project="Mobile Chrome" --project="Mobile Safari"
      env:
        BASE_URL: http://localhost:8080
      working-directory: e2e

    - name: Stop docker-compose
      run: docker compose -f docker-compose.ci.yml down
      working-directory: e2e

      if: always()
